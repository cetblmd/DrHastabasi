<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DrHastaBaşı • User Guide (Demo) V007</title>
<style>
:root{
  --ugBg:#0b1220;
  --ugPanel: rgba(255,255,255,0.06);
  --ugText:#e8eefc;
  --ugMut:#a9b6d3;
  --ugLine: rgba(255,255,255,0.12);
  --ugAccent:#4f8cff;
  --ugAccent2:#9cc1ff;
  --ugWarn:#ffcc66;
  --ugOk:#5eead4;
  --ugRadius:16px;
  --ugShadow: 0 18px 60px rgba(0,0,0,0.38);
  --ugFont: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
html,body{height:100%}
body{
  margin:0;
  font-family: var(--ugFont);
  background: radial-gradient(1200px 800px at 10% 0%, rgba(79,140,255,0.25), transparent 55%),
              radial-gradient(900px 700px at 90% 10%, rgba(94,234,212,0.16), transparent 60%),
              var(--ugBg);
  color: var(--ugText);
}
#app{
  height:100%;
  display:grid;
  grid-template-columns: 360px 1fr;
  gap: 14px;
  padding: 14px;
  box-sizing:border-box;
}
@media (max-width: 980px){
  #app{grid-template-columns:1fr; grid-template-rows: auto 1fr}
}
.card{
  background: var(--ugPanel);
  border:1px solid var(--ugLine);
  border-radius: var(--ugRadius);
  box-shadow: var(--ugShadow);
  overflow:hidden;
}
#side{display:flex; flex-direction:column; min-height:0}
#sideHead{
  padding:14px 14px 10px 14px;
  border-bottom:1px solid var(--ugLine);
  background: linear-gradient(180deg, rgba(255,255,255,0.06), transparent);
}
#sideHead .t{font-weight:800; font-size:16px; letter-spacing:0.2px}
#sideHead .s{margin-top:6px; color:var(--ugMut); font-size:13px; line-height:1.35}
#sideHead .mini{margin-top:10px; color:rgba(232,238,252,0.80); font-size:12.5px; line-height:1.35}
#sideHead code{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;
  color: rgba(156,193,255,0.95);
}
#steps{padding:10px; display:flex; flex-direction:column; gap:8px; overflow:auto; min-height:0}
.stepBtn{
  width:100%;
  border:1px solid var(--ugLine);
  background: rgba(255,255,255,0.04);
  color: var(--ugText);
  border-radius: 14px;
  padding: 10px 10px;
  cursor:pointer;
  text-align:left;
  display:flex;
  gap:10px;
  align-items:flex-start;
}
.stepBtn:hover{background: rgba(255,255,255,0.07)}
.stepBtn[data-active="1"]{
  border-color: rgba(79,140,255,0.55);
  box-shadow: 0 0 0 2px rgba(79,140,255,0.22) inset;
  background: rgba(79,140,255,0.10);
}
.badge{
  flex:0 0 auto;
  width:24px;
  height:24px;
  border-radius: 9px;
  display:grid;
  place-items:center;
  background: rgba(255,255,255,0.07);
  border:1px solid rgba(255,255,255,0.12);
  color: var(--ugAccent2);
  font-weight:900;
  font-size:12px;
  margin-top:1px;
}
.stTitle{font-weight:900; font-size:13px}
.stDesc{color:var(--ugMut); font-size:12.5px; margin-top:3px; line-height:1.25}

#sideFoot{
  padding:12px 12px;
  border-top:1px solid var(--ugLine);
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.btn{
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.07);
  color: var(--ugText);
  border-radius: 14px;
  height: 38px;
  padding: 0 12px;
  cursor:pointer;
  font-weight:900;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.btn:hover{background: rgba(255,255,255,0.10)}
.btnPrimary{
  border-color: rgba(79,140,255,0.55);
  background: rgba(79,140,255,0.14);
}
.btnPrimary:hover{background: rgba(79,140,255,0.20)}
.btn:active{transform: translateY(1px)}
.ctrl{
  display:flex;
  align-items:center;
  gap:10px;
  padding: 0 10px;
  height:38px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.05);
}
.ctrl span{font-size:12.5px; color:var(--ugMut); font-weight:800}
.ctrl input[type="range"]{width:120px}

#main{position:relative; min-height:0}
#mainHead{
  padding:14px 14px 10px 14px;
  border-bottom:1px solid var(--ugLine);
  display:flex;
  gap:12px;
  align-items:flex-start;
  justify-content:space-between;
  background: linear-gradient(180deg, rgba(255,255,255,0.05), transparent);
}
#mainHead .mt{font-weight:950; font-size:16px}
#mainHead .ms{color:var(--ugMut); font-size:13px; margin-top:4px; line-height:1.35}
#mainHeadLeft{min-width:0}
#mainHeadRight{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
.chip{
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: var(--ugMut);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12.5px;
  display:inline-flex;
  align-items:center;
  gap:10px;
}
.tog{
  cursor:pointer;
  width:44px;height:24px;border-radius:999px;
  border:1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.08);
  position:relative;
}
.tog:before{
  content:"";
  position:absolute;
  top:2px; left:2px;
  width:18px;height:18px;border-radius:50%;
  background: rgba(255,255,255,0.85);
  transition: transform .18s ease;
}
.tog[data-on="1"]{border-color: rgba(94,234,212,0.45); background: rgba(94,234,212,0.10)}
.tog[data-on="1"]:before{transform: translateX(20px); background: rgba(94,234,212,0.95)}
#viewerWrap{position:relative; height:calc(100% - 86px); min-height:0; background:#0a0f18}
@media (max-width:980px){
  #viewerWrap{height:calc(100% - 112px)}
}
#viewer{
  width:100%;
  height:100%;
  border:0;
  background:#fff;
}
#overlay{
  position:absolute;
  inset:0;
  pointer-events:none;
}
.mask{
  position:absolute;
  inset:0;
  background: rgba(0,0,0,0.40);
}
.hl{
  position:absolute;
  border-radius: 14px;
  border: 2px solid rgba(79,140,255,0.98);
  box-shadow: 0 0 0 6px rgba(79,140,255,0.20);
  background: rgba(79,140,255,0.08);
}
.targetPulse{
  position:absolute;
  border-radius: 18px;
  border: 2px solid rgba(94,234,212,0.55);
  box-shadow: 0 0 0 10px rgba(94,234,212,0.10);
  animation: tPulse 1.1s ease-in-out infinite;
}
@keyframes tPulse{
  0%{opacity:0.55; transform: scale(0.98)}
  50%{opacity:1; transform: scale(1.02)}
  100%{opacity:0.55; transform: scale(0.98)}
}
.tip{
  position:absolute;
  max-width: 340px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,0.16);
  background: rgba(15,23,42,0.86);
  backdrop-filter: blur(10px);
  color: var(--ugText);
  box-shadow: 0 16px 55px rgba(0,0,0,0.45);
  padding: 10px 10px;
}
.tip .tt{font-weight:950; font-size:13px}
.tip .tx{color: var(--ugMut); font-size:12.5px; margin-top:4px; line-height:1.3}
.tip .sm{margin-top:7px; font-size:12px; color: rgba(232,238,252,0.84)}
.line{
  position:absolute;
  height:2px;
  background: rgba(79,140,255,0.85);
  transform-origin: left center;
  border-radius: 999px;
  box-shadow: 0 0 0 2px rgba(79,140,255,0.10);
}
#toast{
  position:absolute;
  inset:auto 12px 12px 12px;
  display:none;
  border:1px solid rgba(255,204,102,0.35);
  background: rgba(255,204,102,0.08);
  color: var(--ugText);
  border-radius: 14px;
  padding: 10px 10px;
  box-shadow: 0 16px 55px rgba(0,0,0,0.35);
}
#toast b{color: var(--ugWarn)}

#guideCursor{
  position:absolute;
  width:22px;height:22px;
  border-radius: 7px;
  border:2px solid rgba(255,255,255,0.92);
  background: rgba(94,234,212,0.96);
  box-shadow: 0 16px 50px rgba(0,0,0,0.45), 0 0 0 8px rgba(94,234,212,0.18);
  transform: translate(-50%,-50%);
  opacity: 0;
}
#guideCursor[data-show="1"]{opacity:1}
#cursorStart{
  position:absolute;
  width:18px;height:18px;
  border-radius: 7px;
  border:2px dashed rgba(255,255,255,0.55);
  background: rgba(255,255,255,0.06);
  box-shadow: 0 0 0 10px rgba(79,140,255,0.10);
  transform: translate(-50%,-50%);
  opacity: 0;
}
#cursorStart[data-show="1"]{opacity:1}
#cursorRing{
  position:absolute;
  width:76px;height:76px;
  border-radius: 999px;
  border:2px solid rgba(94,234,212,0.55);
  box-shadow: 0 0 0 10px rgba(94,234,212,0.10);
  transform: translate(-50%,-50%) scale(0.86);
  opacity:0;
  pointer-events:none;
}
#cursorRing[data-on="1"]{
  opacity:1;
  animation: ring 0.55s ease-out forwards;
}
@keyframes ring{
  0%{transform: translate(-50%,-50%) scale(0.75); opacity:0.9}
  100%{transform: translate(-50%,-50%) scale(1.20); opacity:0}
}
</style>
</head>
<body>
<div id="app">
  <div id="side" class="card">
    <div id="sideHead">
      <div class="t">User Guide • Demo (V007)</div>
      <div class="s">Adım seç → hedef belirginleşir → cursor başlangıç noktasından yavaşça gider → varınca tıklar.</div>
      <div class="mini"><code>../DrHastaBasi.html</code> ve <code>../MenuAyarlari.html</code> yüklenir. Help dosyası <code>help/</code> içinde olmalı.</div>
    </div>

    <div id="steps"></div>

    <div id="sideFoot">
      <button class="btn" id="btnPrev">← Önceki</button>
      <button class="btn btnPrimary" id="btnNext">Sonraki →</button>
      <button class="btn btnPrimary" id="btnPlay">Otomatik Oynat</button>
      <div class="ctrl">
        <span>Hız</span>
        <input id="rngSpeed" type="range" min="0.4" max="2.0" step="0.1" value="1.0">
      </div>
      <button class="btn" id="btnStop">Durdur</button>
    </div>
  </div>

  <div id="main" class="card">
    <div id="mainHead">
      <div id="mainHeadLeft">
        <div class="mt" id="mainTitle">…</div>
        <div class="ms" id="mainDesc">…</div>
      </div>
      <div id="mainHeadRight">
        <div class="chip" id="chipWhere">Ekran: …</div>
        <div class="chip">
          <span>Fit</span><span class="tog" id="togFit" data-on="1"></span>
        </div>
        <button class="btn" id="btnReset">Sıfırla</button>
      </div>
    </div>

    <div id="viewerWrap">
      <iframe id="viewer" src="about:blank" title="Ekran"></iframe>
      <div id="overlay">
        <div id="cursorStart"></div>
        <div id="guideCursor"></div>
        <div id="cursorRing"></div>
      </div>
      <div id="toast"><b>Not:</b> Hedef öğe henüz oluşmadı. Biraz bekleyip tekrar deniyorum…</div>
    </div>
  </div>
</div>

<script>
(function(){
  var qs = function(sel, root){ return (root || document).querySelector(sel); };
  var qsa = function(sel, root){ return Array.prototype.slice.call((root || document).querySelectorAll(sel)); };

  var overlay = qs('#overlay');
  var iframe = qs('#viewer');
  var toast = qs('#toast');

  var togFit = qs('#togFit');
  var cursor = qs('#guideCursor');
  var cursorStart = qs('#cursorStart');
  var ring = qs('#cursorRing');
  var rngSpeed = qs('#rngSpeed');

  var btnPlay = qs('#btnPlay');
  var btnStop = qs('#btnStop');

  var PATHS = {
    dr: "../DrHastaBasi.html?DrID=99999999",
    menu: "../MenuAyarlari.html?drid=99999999"
  };

  function esc(s){
    return String(s == null ? '' : s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  var STEPS = [
    {
      id: "s1",
      title: "Menü Ayarları ekranını aç",
      desc: "Sağ üstteki Ayarlar (çark) butonuna bas.",
      where: "DrHastaBaşı",
      screen: "dr",
      click: { type: "click", selector: "#doctorGear" },
      highlights: [
        { selector: "#doctorGear", title: "Ayarlar (Çark)", text: "Buraya basınca Özelleştir menüsü açılır.", align: "left" }
      ],
      pre: []
    },
    {
      id: "s2",
      title: "Menü Ayarları'na gir",
      desc: "Özelleştir panelinden “Menü Ayarları”nı seç.",
      where: "DrHastaBaşı → Özelleştir",
      screen: "dr",
      click: { type: "click", selector: "#hbOzMenuAyar" },
      highlights: [
        { selector: "#hbOzMenuAyar", title: "Menü Ayarları", text: "Menü düzenleme ekranını açar.", align: "left" }
      ],
      pre: [ { type: "click", selector: "#doctorGear" } ]
    },
    {
      id: "s3",
      title: "Program Havuzu'ndan bir program seç",
      desc: "Program Havuzu kutusunda bir programı bul ve sürükle.",
      where: "Menü Ayarları",
      screen: "menu",
      click: null,
      highlights: [
        { selector: "#panelPool", title: "Program Havuzu", text: "Programlar burada listelenir. Birini sürükle.", align: "right" }
      ],
      pre: []
    },
    {
      id: "s4",
      title: "Sol veya Sağ Menü alanına sürükle",
      desc: "Seçtiğin programı Sol Menü (MiniPanel) veya Sağ Menü alanına bırak.",
      where: "Menü Ayarları",
      screen: "menu",
      click: null,
      highlights: [
        { selector: "#panelMini", title: "Sol Menü", text: "Sık kullanılanları sol menüye sürükleyebilirsin.", align: "left" },
        { selector: "#panelMenu", title: "Sağ Menü", text: "Alternatif olarak sağ menüye de bırakabilirsin.", align: "right" }
      ],
      pre: []
    },
    {
      id: "s5",
      title: "Kaydet & Çık",
      desc: "Kaydet ile kalıcı hale getir, Çık ile DrHastaBaşı'na dön.",
      where: "Menü Ayarları",
      screen: "menu",
      click: null,
      highlights: [
        { selector: "#hbSaveBtn", title: "Kaydet", text: "Değişiklikleri kaydeder.", align: "right" },
        { selector: "#hbExitBtn", title: "Çık", text: "Kaydetmeden çıkarsan uyarı alabilirsin.", align: "right" }
      ],
      pre: []
    }
  ];

  var state = {
    i: 0,
    lastKey: "",
    curX: 110,
    curY: 110,
    anim: 0,
    playing: false,
    playToken: 0
  };

  function toastShow(){
    toast.style.display = "block";
    clearTimeout(toast.__t);
    toast.__t = setTimeout(function(){ toast.style.display = "none"; }, 1500);
  }

  function clearOverlay(){
    overlay.innerHTML = "";
    overlay.appendChild(cursorStart);
    overlay.appendChild(cursor);
    overlay.appendChild(ring);
  }

  function getFrameDoc(){
    try{ return iframe.contentDocument || iframe.contentWindow.document; }catch(e){ return null; }
  }

  function applyFit(){
    var d = getFrameDoc();
    if(!d) return;
    var on = togFit.getAttribute("data-on") === "1";
    try{ d.documentElement.style.transformOrigin = "0 0"; d.documentElement.style.zoom = ""; }catch(e){}
    if(!on) return;
    try{
      var sw = Math.max(d.documentElement.scrollWidth || 0, d.body ? (d.body.scrollWidth||0) : 0);
      var sh = Math.max(d.documentElement.scrollHeight || 0, d.body ? (d.body.scrollHeight||0) : 0);
      var cw = iframe.clientWidth || 1;
      var ch = iframe.clientHeight || 1;
      var sx = cw / Math.max(1, sw);
      var sy = ch / Math.max(1, sh);
      var s = Math.min(1, sx, sy);
      if(isFinite(s) && s > 0.25 && s < 1){ d.documentElement.style.zoom = String(s); }
    }catch(e){}
  }

  function rectToOverlayRect(r){
    var fr = iframe.getBoundingClientRect();
    return { left: r.left - fr.left, top: r.top - fr.top, width: r.width, height: r.height };
  }

  function addMask(){
    var m = document.createElement("div");
    m.className = "mask";
    overlay.appendChild(m);
  }

  function addHighlight(rect){
    var hl = document.createElement("div");
    hl.className = "hl";
    hl.style.left = String(Math.max(0, rect.left - 6)) + "px";
    hl.style.top = String(Math.max(0, rect.top - 6)) + "px";
    hl.style.width = String(Math.max(8, rect.width + 12)) + "px";
    hl.style.height = String(Math.max(8, rect.height + 12)) + "px";
    overlay.appendChild(hl);

    var tp = document.createElement("div");
    tp.className = "targetPulse";
    tp.style.left = String(Math.max(0, rect.left - 10)) + "px";
    tp.style.top = String(Math.max(0, rect.top - 10)) + "px";
    tp.style.width = String(Math.max(12, rect.width + 20)) + "px";
    tp.style.height = String(Math.max(12, rect.height + 20)) + "px";
    overlay.appendChild(tp);
  }

  function placeTipFor(rect, tipEl, align){
    var pad = 10, tw = 340, th = 120;
    var x = rect.left, y = rect.top, w = rect.width, h = rect.height;
    var px = x + w + 14, py = y;
    if(align === "left"){ px = Math.max(pad, x - tw - 14); }
    if(px + tw > overlay.clientWidth - pad){ px = Math.max(pad, overlay.clientWidth - tw - pad); }
    if(py + th > overlay.clientHeight - pad){ py = Math.max(pad, overlay.clientHeight - th - pad); }
    if(py < pad){ py = pad; }
    tipEl.style.left = String(px) + "px";
    tipEl.style.top = String(py) + "px";

    var cx = (align === "left") ? (px + tw) : px;
    var cy = py + 22;
    var tx = x + w/2, ty = y + h/2;
    var dx = tx - cx, dy = ty - cy;
    var len = Math.sqrt(dx*dx + dy*dy);
    if(!isFinite(len) || len < 30) return;
    var ang = Math.atan2(dy, dx) * 180 / Math.PI;

    var line = document.createElement("div");
    line.className = "line";
    line.style.left = String(cx) + "px";
    line.style.top = String(cy) + "px";
    line.style.width = String(len) + "px";
    line.style.transform = "rotate(" + String(ang) + "deg)";
    overlay.appendChild(line);
  }

  function addTip(rect, title, text, align){
    var tip = document.createElement("div");
    tip.className = "tip";
    tip.innerHTML = "<div class='tt'>" + esc(title) + "</div><div class='tx'>" + esc(text) + "</div><div class='sm'>Hedef alan</div>";
    overlay.appendChild(tip);
    placeTipFor(rect, tip, align || "right");
  }

  function runAction(a){
    if(!a) return;
    var d = getFrameDoc();
    if(!d) return;
    if(a.type === "click"){
      var el = null;
      try{ el = d.querySelector(a.selector); }catch(e){}
      if(el){
        try{ el.scrollIntoView({block:"center", inline:"center"}); }catch(e){}
        try{ el.click(); }catch(e){}
      }
    }
  }

  function waitForAny(selectors, timeoutMs){
    var start = Date.now();
    return new Promise(function(resolve){
      (function tick(){
        var d = getFrameDoc();
        if(!d){ resolve(null); return; }
        for(var i=0;i<selectors.length;i+=1){
          var s = selectors[i];
          var el = null;
          try{ el = d.querySelector(s.selector); }catch(e){}
          if(el){ resolve(el); return; }
        }
        if(Date.now() - start > timeoutMs){ resolve(null); return; }
        setTimeout(tick, 120);
      })();
    });
  }

  function ease(t){
    return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2, 3)/2;
  }

  function cursorClickFx(x, y){
    ring.style.left = String(x) + "px";
    ring.style.top = String(y) + "px";
    ring.setAttribute("data-on","0");
    ring.offsetHeight;
    ring.setAttribute("data-on","1");
  }

  function cursorMoveWithStart(xFrom, yFrom, xTo, yTo, ms){
    cancelAnimationFrame(state.anim);

    cursorStart.style.left = String(xFrom) + "px";
    cursorStart.style.top = String(yFrom) + "px";
    cursorStart.setAttribute("data-show","1");

    cursor.style.left = String(xFrom) + "px";
    cursor.style.top = String(yFrom) + "px";
    cursor.setAttribute("data-show","1");

    state.curX = xFrom;
    state.curY = yFrom;

    var t0 = performance.now();
    var dur = Math.max(260, ms || 900);

    function step(now){
      var p = (now - t0) / dur;
      if(p < 0) p = 0;
      if(p > 1) p = 1;
      var k = ease(p);
      state.curX = xFrom + (xTo - xFrom) * k;
      state.curY = yFrom + (yTo - yFrom) * k;
      cursor.style.left = String(state.curX) + "px";
      cursor.style.top = String(state.curY) + "px";
      if(p < 1){
        state.anim = requestAnimationFrame(step);
      }else{
        cursorStart.setAttribute("data-show","0");
      }
    }
    state.anim = requestAnimationFrame(step);
  }

  function buildSteps(){
    var host = qs('#steps');
    host.innerHTML = "";
    for(var i=0;i<STEPS.length;i+=1){
      var s = STEPS[i];
      var b = document.createElement('button');
      b.type = "button";
      b.className = "stepBtn";
      b.setAttribute('data-step', String(i));
      b.setAttribute('data-active', "0");
      b.innerHTML =
        "<div class='badge'>" + String(i+1) + "</div>" +
        "<div style='min-width:0'>" +
          "<div class='stTitle'>" + esc(s.title) + "</div>" +
          "<div class='stDesc'>" + esc(s.desc) + "</div>" +
        "</div>";
      b.addEventListener('click', (function(ix){ return function(){ stopPlay(); setStep(ix, true); }; })(i));
      host.appendChild(b);
    }
  }

  function updateActive(){
    qsa('.stepBtn').forEach(function(b){
      b.setAttribute('data-active', b.getAttribute('data-step') === String(state.i) ? '1' : '0');
    });
  }

  function setHeader(step){
    qs('#mainTitle').textContent = String((state.i+1) + ". " + (step.title || ""));
    qs('#mainDesc').textContent = String(step.desc || "");
    qs('#chipWhere').textContent = "Ekran: " + String(step.where || "");
  }

  function loadScreen(key){
    var url = PATHS[key] || "about:blank";
    if(state.lastKey !== key){
      state.lastKey = key;
      iframe.src = url;
      return true;
    }
    return false;
  }

  async function stepAnimateAndMaybeClick(step, doClick){
    clearOverlay();
    toast.style.display = "none";

    var d = getFrameDoc();
    if(!d) return;

    applyFit();

    if(step.pre && step.pre.length){
      for(var i=0;i<step.pre.length;i+=1){
        runAction(step.pre[i]);
      }
    }

    var el = await waitForAny(step.highlights, 2400);
    if(!el){
      toastShow();
      addMask();
      return;
    }

    try{ el.scrollIntoView({block:"center", inline:"center"}); }catch(e){}
    try{ applyFit(); }catch(e){}

    var r = null;
    try{ r = el.getBoundingClientRect(); }catch(e){}
    if(!r) return;

    var rr = rectToOverlayRect(r);

    addMask();
    addHighlight(rr);
    addTip(rr, step.highlights[0].title || "Hedef", step.highlights[0].text || "", step.highlights[0].align || "right");

    var tx = rr.left + rr.width/2;
    var ty = rr.top + rr.height/2;

    var fromX = Math.max(24, Math.min(overlay.clientWidth - 24, tx - 240));
    var fromY = Math.max(24, Math.min(overlay.clientHeight - 24, ty + 140));

    var speed = parseFloat(rngSpeed.value || "1") || 1;
    var ms = Math.round(1100 / speed);

    cursorMoveWithStart(fromX, fromY, tx, ty, ms);

    await new Promise(function(res){ setTimeout(res, ms + 120); });

    cursorClickFx(tx, ty);

    if(doClick && step.click){
      runAction(step.click);
    }
  }

  function setStep(idx, doClick){
    if(idx < 0) idx = 0;
    if(idx >= STEPS.length) idx = STEPS.length - 1;
    state.i = idx;
    updateActive();
    var step = STEPS[state.i];
    setHeader(step);

    var loaded = loadScreen(step.screen);
    if(!loaded){
      setTimeout(function(){ stepAnimateAndMaybeClick(step, !!doClick); }, 120);
    }else{
      // render after load
    }
  }

  function stopPlay(){
    state.playing = false;
    state.playToken += 1;
    btnPlay.textContent = "Otomatik Oynat";
  }

  async function playAll(){
    if(state.playing) return;
    state.playing = true;
    var token = (state.playToken += 1);
    btnPlay.textContent = "Oynatılıyor…";

    for(var i=state.i;i<STEPS.length;i+=1){
      if(!state.playing || token !== state.playToken) return;
      state.i = i;
      updateActive();
      var step = STEPS[state.i];
      setHeader(step);

      var loaded = loadScreen(step.screen);
      if(loaded){
        await new Promise(function(res){
          var once = function(){
            iframe.removeEventListener('load', once);
            res();
          };
          iframe.addEventListener('load', once);
        });
      }else{
        await new Promise(function(res){ setTimeout(res, 80); });
      }

      if(!state.playing || token !== state.playToken) return;

      var doClick = !!(step.click);
      await stepAnimateAndMaybeClick(step, doClick);

      await new Promise(function(res){ setTimeout(res, 520); });
    }

    stopPlay();
  }

  iframe.addEventListener('load', function(){
    var step = STEPS[state.i];
    setTimeout(function(){ stepAnimateAndMaybeClick(step, true); }, 140);
  });

  qs('#btnPrev').addEventListener('click', function(){ stopPlay(); setStep(state.i - 1, true); });
  qs('#btnNext').addEventListener('click', function(){ stopPlay(); setStep(state.i + 1, true); });

  btnPlay.addEventListener('click', function(){
    if(state.playing){ stopPlay(); return; }
    playAll();
  });

  btnStop.addEventListener('click', function(){ stopPlay(); });

  qs('#btnReset').addEventListener('click', function(){
    stopPlay();
    state.lastKey = "";
    clearOverlay();
    setStep(state.i, false);
  });

  togFit.addEventListener('click', function(){
    var on = togFit.getAttribute("data-on") === "1";
    togFit.setAttribute("data-on", on ? "0" : "1");
    setTimeout(function(){ stepAnimateAndMaybeClick(STEPS[state.i], false); }, 110);
  });

  buildSteps();
  cursor.style.left = "110px";
  cursor.style.top = "110px";
  cursor.setAttribute("data-show","1");
  setStep(0, false);
})();
</script>
</body>
</html>
