<!DOCTYPE html>
<html lang='tr'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>RadyolojiWidget_V02</title>
    <script src='BilmedUiLib.js'></script>
    <style>
:root{
    --wRadius: 14px;
    --wPad: 12px;
    --wGap: 10px;
    --wLine: var(--bilmed-surface-border, rgba(15,23,42,0.12));
    --wBg: var(--bilmed-surface-bg, #fff);
    --wText: var(--bilmed-surface-text, #0f172a);
    --wMuted: rgba(15,23,42,0.72);
    --wTint: var(--bilmed-tint-bg, rgba(0,0,0,0.04));
    --wPrimary: var(--bilmed-primary-bg, #2563eb);
}
html, body{
    margin: 0;
    padding: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: transparent;
    color: var(--wText);
}
#wrap{
    box-sizing: border-box;
    width: 100%;
    height: 100%;
}
#wCard{
    border: 1px solid var(--wLine);
    background: var(--wBg);
    border-radius: var(--wRadius);
    overflow: hidden;
}
#wHead{
    padding: var(--wPad);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--wGap);
    border-bottom: 1px solid var(--wLine);
    background: var(--wTint);
}
#wTitle{
    font-weight: 900;
    font-size: 13px;
    letter-spacing: 0.2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#wMeta{
    font-weight: 800;
    font-size: 11px;
    color: var(--wMuted);
    white-space: nowrap;
}
#wBody{
    padding: var(--wPad);
    display: flex;
    flex-direction: column;
    gap: 10px;
}
#wList{
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.wRow{
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 10px;
    border: 1px solid var(--wLine);
    border-radius: 12px;
    background: var(--wTint);
    box-sizing: border-box;
    min-width: 0;
}
.wLeft{
    flex: 1;
    min-width: 0;
}
.wTop{
    display: flex;
    align-items: baseline;
    gap: 8px;
    min-width: 0;
}
.wName{
    font-weight: 900;
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.wSub{
    font-weight: 800;
    font-size: 11px;
    color: var(--wMuted);
    white-space: nowrap;
}
.wDesc{
    margin-top: 4px;
    font-size: 11px;
    color: var(--wMuted);
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}
.wBadge{
    flex: 0 0 auto;
    font-weight: 900;
    font-size: 11px;
    padding: 6px 8px;
    border-radius: 999px;
    border: 1px solid var(--wLine);
    background: var(--wBg);
    color: var(--wText);
    user-select: none;
}
#wActions{
    display: flex;
    gap: 8px;
}
.wBtn{
    height: 32px;
    padding: 0 12px;
    border-radius: 10px;
    border: 1px solid var(--wLine);
    background: var(--wBg);
    color: var(--wText);
    font-weight: 900;
    cursor: pointer;
}
.wBtn:hover{
    background: var(--wTint);
}
.wBtnPrimary{
    border-color: var(--wPrimary);
    background: var(--wPrimary);
    color: #fff;
}
.wBtnPrimary:hover{
    opacity: 0.92;
}
.wSmallNote{
    font-size: 11px;
    color: var(--wMuted);
    font-weight: 800;
}
</style>
</head>
<body>
<div id='wrap'>
    <div id='wCard'>
        <div id='wHead'>
            <div style='min-width:0'>
                <div id='wTitle'>Görüntüleme Sonuçları</div>
                <div id='wMeta'></div>
            </div>
            <div id='wActions'>
                <button id='btnRefresh' class='wBtn' type='button'>Yenile</button>
                <button id='btnFull' class='wBtn wBtnPrimary' type='button' aria-label='Radyoloji Detay'>Detay</button>
            </div>
        </div>
        <div id='wBody'>
            <div id='wList'></div>
            <div id='wFoot' class='wSmallNote'></div>
        </div>
    </div>
</div>

<script>
'use strict';

var __ctx = {
    drId: 0,
    hastaId: 0,
    hizmetId: 0
};

var __themeId = '';
var __suspended = 0;
var __lastNow = Date.now();
var __items = [];

function __qs(id){
    return document.getElementById(id);
}

function __pad2(n){
    var s = String(Math.floor(Number(n) || 0));
    if(s.length < 2) { return '0' + s; }
    return s;
}

function __fmtDt(ts){
    var d = new Date(Number(ts) || Date.now());
    return __pad2(d.getDate()) + '.' + __pad2(d.getMonth() + 1) + '.' + d.getFullYear() + ' ' + __pad2(d.getHours()) + ':' + __pad2(d.getMinutes());
}

function __hashInt(x){
    var t = String(Number(x) || 0);
    var h = 2166136261;
    for(var i = 0; i < t.length; i += 1){
        h ^= t.charCodeAt(i);
        h = Math.imul(h, 16777619);
    }
    h = h >>> 0;
    return h;
}

function __rand01(seed, salt){
    var h = __hashInt(seed) ^ __hashInt(salt);
    h = (h ^ (h >>> 16)) >>> 0;
    return (h % 10000) / 10000;
}

function __pick(arr, r){
    var idx = Math.floor(r * arr.length);
    if(idx < 0) { idx = 0; }
    if(idx >= arr.length) { idx = arr.length - 1; }
    return arr[idx];
}

function __makeItems(kind, hastaId, nowMs){
    var seed = __hashInt(hastaId) ^ __hashInt(Math.floor(nowMs / 60000));
    if(kind === 'rad'){
        var mods = ['Direkt Grafi', 'BT', 'MR', 'USG', 'EKO'];
        var parts = ['Akciğer', 'Karın', 'Beyin', 'Kalça', 'Diz', 'Servikal', 'Lomber'];
        var statuses = ['Raporlandı', 'Beklemede', 'İnceleniyor'];
        var out = [];
        for(var i = 0; i < 5; i += 1){
            var r1 = __rand01(seed, i + 11);
            var r2 = __rand01(seed, i + 71);
            var r3 = __rand01(seed, i + 131);
            var dt = nowMs - Math.floor((r2 * 72 + 2) * 3600 * 1000);
            out.push({
                name: __pick(mods, r1) + ' - ' + __pick(parts, r2),
                sub: __fmtDt(dt),
                desc: (r3 < 0.55) ? 'Ön değerlendirme hazır. Rapor onayı bekleniyor.' : 'Rapor tamamlandı. Klinik korelasyon önerilir.',
                badge: __pick(statuses, r3),
            });
        }
        return out;
    }
    if(kind === 'tani'){
        var codes = ['I10', 'E11.9', 'J06.9', 'K21.9', 'M54.5', 'R07.9', 'N39.0'];
        var names = ['Esansiyel hipertansiyon', 'Tip 2 DM', 'ÜSYE', 'Reflü', 'Bel ağrısı', 'Göğüs ağrısı', 'İYE'];
        var states = ['Aktif', 'Geçmiş', 'Şüpheli'];
        var out2 = [];
        for(var j = 0; j < 6; j += 1){
            var rr = __rand01(seed, j + 21);
            var idx = Math.floor(__rand01(seed, j + 221) * codes.length);
            if(idx < 0) { idx = 0; }
            if(idx >= codes.length) { idx = codes.length - 1; }
            var dt2 = nowMs - Math.floor((rr * 40 + 1) * 24 * 3600 * 1000);
            out2.push({
                name: codes[idx] + ' - ' + names[idx],
                sub: __fmtDt(dt2),
                desc: (rr < 0.5) ? 'Klinik bulgularla uyumlu. Takip önerilir.' : 'Tanı doğrulama/izlem planı değerlendirilir.',
                badge: __pick(states, rr),
            });
        }
        return out2;
    }
    var panels = ['Kan Gazı', 'Trombosit', 'CRP', 'D-Dimer', 'TSH', 'B12', 'Folat', 'HbA1c'];
    var states2 = ['Sonuçlandı', 'Beklemede'];
    var out3 = [];
    for(var k = 0; k < 5; k += 1){
        var rx = __rand01(seed, k + 31);
        var ry = __rand01(seed, k + 331);
        var dt3 = nowMs - Math.floor((ry * 18 + 1) * 3600 * 1000);
        out3.push({
            name: __pick(panels, rx),
            sub: __fmtDt(dt3),
            desc: (rx < 0.45) ? 'Kontrol/teyit amaçlı istenmiştir.' : 'Klinik izlem için değerlendiriniz.',
            badge: __pick(states2, rx),
        });
    }
    return out3;
}

function __render(){
    var meta = '';
    if(__ctx.hastaId > 0) {
        meta = 'Hasta: ' + String(__ctx.hastaId);
    } else {
        meta = 'Hasta: -';
    }
    __qs('wMeta').textContent = meta;

    var listEl = __qs('wList');
    while(listEl.firstChild) {
        listEl.removeChild(listEl.firstChild);
    }

    for(var i = 0; i < __items.length; i += 1){
        var it = __items[i];
        var row = document.createElement('div');
        row.className = 'wRow';

        var left = document.createElement('div');
        left.className = 'wLeft';

        var top = document.createElement('div');
        top.className = 'wTop';

        var name = document.createElement('div');
        name.className = 'wName';
        name.textContent = it.name;

        var sub = document.createElement('div');
        sub.className = 'wSub';
        sub.textContent = it.sub;

        top.appendChild(name);
        top.appendChild(sub);

        var desc = document.createElement('div');
        desc.className = 'wDesc';
        desc.textContent = it.desc;

        left.appendChild(top);
        left.appendChild(desc);

        var badge = document.createElement('div');
        badge.className = 'wBadge';
        badge.textContent = it.badge;

        row.appendChild(left);
        row.appendChild(badge);

        listEl.appendChild(row);
    }

    __qs('wFoot').textContent = 'Son güncelleme: ' + __fmtDt(__lastNow);
}

function __refresh(){
    __lastNow = Date.now();
    __items = __makeItems('rad', __ctx.hastaId, __lastNow);
    __render();
}

function __post(type, payload){
    try {
        window.parent.postMessage({ type: type, payload: payload || {} }, '*');
    } catch(e) {
        console.error('WIDGET_POST_FAIL', e);
    }
}

function __applyTheme(){
    try {
        if(typeof BilmedThema === 'function') {
            BilmedThema(__ctx.drId || 0, document, false);
        }
    } catch(e) {
        console.error('WIDGET_THEME_APPLY_FAIL', e);
    }
}

function __onMessage(ev){
    var msg = ev && ev.data ? ev.data : null;
    if(!msg || typeof msg.type !== 'string') { return; }
    var t = msg.type;
    var p = msg.payload || {};

    if(t === 'CTX_SET') {
        __ctx.drId = Math.floor(Number(p.drId) || 0);
        __ctx.hastaId = Math.floor(Number(p.hastaId) || 0);
        __ctx.hizmetId = Math.floor(Number(p.hizmetId) || 0);
        __applyTheme();
        __refresh();
        return;
    }

    if(t === 'THEME_SET') {
        __themeId = String(p.themeId || '');
        __applyTheme();
        return;
    }

    if(t === 'SUSPEND') {
        __suspended = 1;
        return;
    }

    if(t === 'RESUME') {
        __suspended = 0;
        return;
    }
}

function __openFull(){
    __post('OPEN_FULL', {
        pageId: 'radFull',
        url: 'RadFull_V02.html',
        title: 'Radyoloji'
    });
}

function __bind(){
    __qs('btnFull').addEventListener('click', function(){
        __openFull();
    });

    __qs('btnRefresh').addEventListener('click', function(){
        if(__suspended) { return; }
        __refresh();
        __post('ACTION', {
            action: 'refresh',
            source: 'RadyolojiWidget',
            data: { hastaId: __ctx.hastaId }
        });
    });
}

function __init(){
    window.addEventListener('message', __onMessage);
    __bind();
    __refresh();
    __post('READY', { host: 'Widget', widget: 'Radyoloji', version: 'V02' });
}

__init();
</script>
</body>
</html>
