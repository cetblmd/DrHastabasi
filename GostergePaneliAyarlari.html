<!DOCTYPE html>
<html lang='tr'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<title>Gosterge Paneli Ayarlari</title>

<script src='BilmedUiLib.js'></script>
<script src='HB_ItemCatalog.js'></script>
<script src='HB_SharedLib.js'></script>

<style>
    :root{
        --gpRadius: 16px;
        --gpPad: 14px;
        --gpPageBg: var(--bilmed-page-bg, var(--bilmed-surface-bg, #f3f4f6));
        --gpSurfaceBg: var(--bilmed-surface-bg, rgba(255,255,255,0.82));
        --gpSurfaceBorder: var(--bilmed-surface-border, rgba(15, 23, 42, 0.12));
        --gpSurfaceText: var(--bilmed-surface-text, #0f172a);
        --gpTintBg: var(--bilmed-tint-bg, rgba(255,255,255,0.70));
        --gpHeaderBg: var(--bilmed-header2-bg, rgba(255,255,255,0.92));
        --gpHeaderBorder: var(--bilmed-header2-border, var(--gpSurfaceBorder));
        --gpHeaderFg: var(--bilmed-header2-fg, var(--gpSurfaceText));
        --gpPrimaryBg: var(--bilmed-primary-bg, #2563eb);
    }

    html, body{
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
background: var(--gpPageBg) !important;
        color: var(--gpSurfaceText);
    }

    #gpTopBar{
        height: 54px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 14px;
box-sizing: border-box;
        position: sticky;
        top: 0;
        z-index: 5;
        background: var(--gpHeaderBg);
        border-bottom: 1px solid var(--gpHeaderBorder);
        color: var(--gpHeaderFg);
    }

    #gpTopBarLeft{
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 180px;
    }

    #gpTopBarTitle{
        font-weight: 700;
        font-size: 14px;
        opacity: 0.9;
    }

    #gpTopBarRight{
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #gpMain{
        height: calc(100% - 54px);
        display: flex;
        gap: 12px;
        padding: 12px;
        box-sizing: border-box;
    }

    #gpPoolWrap{
        width: 380px;
        min-width: 340px;
        max-width: 520px;
        border-radius: var(--gpRadius);
display: flex;
        flex-direction: column;
        overflow: hidden;
        background: var(--gpSurfaceBg);
        border: 1px solid var(--gpSurfaceBorder);
    }

    #gpPoolHead{
        padding: 12px 12px 10px 12px;
font-weight: 700;
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border-bottom: 1px solid var(--gpSurfaceBorder);
    }

    #gpPoolList{
        flex: 1;
        overflow: auto;
        padding: 10px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .gpPoolCard{
        flex-direction: row;
        align-items: center;
        text-align: left;
        display: flex;
        gap: 10px;
        padding: 10px 10px;
border-radius: 16px;
user-select: none;
        justify-content: flex-start;
        background: var(--gpTintBg);
        border: 1px solid var(--gpSurfaceBorder);
    }

    .gpPoolCard[draggable='true']{
        cursor: grab;
    }

    .gpPoolCard.isPicked{
        border-color: var(--bilmed-primary-bg, var(--gpPrimaryBg));
        box-shadow: 0 0 0 2px rgba(59,130,246,0.25);
    }

    .gpPoolIcon{
        margin-right: 8px;
        width: 34px;
        height: 34px;
        border-radius: 12px;
display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        overflow: hidden;
        background: var(--gpSurfaceBg);
        border: 1px solid var(--gpSurfaceBorder);
    }

    .gpPoolIcon svg{
        width: 20px;
        height: 20px;
        display: block;
    }

    .gpPoolText{
        flex: 1;
        min-width: 0;
        text-align: left;
    }

    .gpPoolTitle{
        font-weight: 800;
        font-size: 13px;
        line-height: 1.1;
        margin-top: 1px;
    }

    .gpPoolDesc{
        margin-top: 6px;
        font-size: 12px;
        line-height: 1.25;
        opacity: 0.85;
        white-space: normal;
        word-break: break-word;
    }

    #gpGridWrap{
        flex: 1;
        border-radius: var(--gpRadius);
overflow: hidden;
        display: flex;
        flex-direction: column;
        min-width: 420px;
        background: var(--gpSurfaceBg);
        border: 1px solid var(--gpSurfaceBorder);
    }

    #gpGridScroll{
        flex: 1;
        overflow: auto;
        padding: var(--gpPad);
        box-sizing: border-box;
        position: relative;
        background-image:
          repeating-linear-gradient(to right, rgba(0,0,0,0.07) 0 1px, transparent 1px calc(var(--gpUnitPx) + var(--gpGap))),
          repeating-linear-gradient(to bottom, rgba(0,0,0,0.07) 0 1px, transparent 1px calc(var(--gpUnitPx) + var(--gpGap)));
        background-size: calc(var(--gpUnitPx) + var(--gpGap)) calc(var(--gpUnitPx) + var(--gpGap));
        background-origin: content-box;
        background-clip: content-box;
    }

    #gpSizeBox{
        position: sticky;
        bottom: 12px;
        margin-left: auto;
        width: max-content;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 14px;
        background: var(--gpSurfaceBg);
        border: 1px solid var(--gpSurfaceBorder);
        box-shadow: 0 10px 30px rgba(0,0,0,0.10);
        z-index: 5;
        user-select: none;
    }
    #gpSizeTitle{
        font-weight: 900;
        font-size: 12px;
        opacity: 0.9;
        max-width: 240px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .gpSizeField{
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        opacity: 0.9;
    }
    .gpSizeField input{
        width: 56px;
        height: 30px;
        border-radius: 10px;
        border: 1px solid var(--gpSurfaceBorder);
        background: var(--gpTintBg);
        padding: 0 10px;
        font-weight: 900;
        outline: none;
    }
    #gpSizeBox.isDisabled{
        opacity: 0.55;
        filter: grayscale(0.2);
    }
    #gpSizeBox.isDisabled input{
        pointer-events: none;
    }

    #gpGrid{
        position: relative;
        display: grid;
        gap: var(--gpGap);
        align-content: start;
        grid-auto-flow: row;
        min-height: 520px;
    }

    .gpGridCard{position: relative;
border-radius: 18px;
user-select: none;
        overflow: hidden;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 2px;
        background: var(--gpTintBg);
        border: 1px solid var(--gpSurfaceBorder);
    }

    .gpGridCard[draggable='true']{
        cursor: grab;
    }

    .gpGridCardInner{
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 10px;
        text-align: center;
        box-sizing: border-box;
    }

    .gpGridIcon{
        width: 34px;
        height: 34px;
        border-radius: 12px;
display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        overflow: hidden;
        background: var(--gpSurfaceBg);
        border: 1px solid var(--gpSurfaceBorder);
    }

    .gpGridIcon svg{
        width: 20px;
        height: 20px;
        display: block;
    }

    .gpGridTitle{
        font-weight: 900;
        font-size: 13px;
        line-height: 1.1;
        margin-top: 1px;
    }

    .gpGridDesc{
        margin-top: 6px;
        font-size: 12px;
        line-height: 1.25;
        opacity: 0.85;
        white-space: normal;
        word-break: break-word;
    }

    .gpDropHint{
        position: absolute;
        pointer-events: none;
        border: 2px dashed rgba(120,120,120,0.75);
        border-radius: 16px;
        background: rgba(170,170,170,0.78);
                
box-sizing: border-box;
        z-index: 999;
        display: none;
    }

        

    .gpDropHint.valid{
        border-color: rgba(0,180,0,0.90);}
    .gpDropHint.invalid{
        border-color: rgba(200,0,0,0.92);}

    #gpSizeBox{
        position: sticky;
        right: 10px;
        bottom: 10px;
        margin-top: 10px;
        margin-left: auto;
        width: 240px;
        border-radius: 16px;
        background: var(--gpSurfaceBg);
        border: 1px solid var(--gpSurfaceBorder);
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        padding: 10px 10px;
        box-sizing: border-box;
        backdrop-filter: blur(2px);
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 50;
    }
    #gpSizeTitle{
        font-size: 12px;
        font-weight: 900;
        line-height: 1.1;
        opacity: 0.92;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .gpSizeRow{
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .gpSizeRow label{
        font-size: 12px;
        font-weight: 800;
        opacity: 0.85;
        width: 22px;
    }
    .gpSizeRow input{
        flex: 1;
        height: 34px;
        border-radius: 12px;
        border: 1px solid var(--gpSurfaceBorder);
        background: var(--gpTintBg);
        padding: 0 10px;
        box-sizing: border-box;
        font-size: 13px;
        font-weight: 800;
        outline: none;
    }
    .gpSizeBtn{
        width: 34px;
        height: 34px;
        border-radius: 12px;
        border: 1px solid var(--gpSurfaceBorder);
        background: var(--gpTintBg);
        color: var(--gpSurfaceText);
        font-weight: 900;
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
        user-select: none;
    }
    .gpSizeBtn:active{
        background: var(--bilmed-primary-bg, var(--gpPrimaryBg));
        color: #fff;
        border-color: var(--bilmed-primary-bg, var(--gpPrimaryBg));
    }
    .gpSizeRow input:disabled{
        opacity: 0.55;
        cursor: not-allowed;
    }


        .gpDragGhost{
            position: fixed;
            left: 0;
            top: 0;
            transform: translate(-10000px, -10000px);
            pointer-events: none;
            z-index: 99999;
            background: rgba(120,120,120,0.28);
            border: 2px solid rgba(120,120,120,0.85);
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            padding: 10px 12px;
            min-width: 180px;
            max-width: 260px;
            backdrop-filter: blur(2px);
        }
        .gpDragGhostRow{
            display:flex;
            align-items:center;
            gap:10px;
        }
        .gpDragGhostIcon{
            width: 34px;
            height: 34px;
            border-radius: 10px;
            background: rgba(255,255,255,0.55);
            border: 1px solid rgba(0,0,0,0.08);
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:700;
            color: rgba(0,0,0,0.55);
            flex: 0 0 auto;
        }
        .gpDragGhostText{
            display:flex;
            flex-direction:column;
            gap:2px;
            min-width:0;
        }
        .gpDragGhostTitle{
            font-weight: 700;
            font-size: 14px;
            color: rgba(0,0,0,0.78);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .gpDragGhostMeta{
            font-size: 12px;
            color: rgba(0,0,0,0.52);
        }
    
    
.gpSearchWrap{
        display:flex;
        align-items:center;
        gap:6px;
        width:100%;
    }
    #gpSearchInput{
        flex:1;
        height:32px;
        border-radius:10px;
padding:0 10px;
        font-size:13px;
        outline:none;
        background: var(--gpSurfaceBg);
        border: 1px solid var(--gpSurfaceBorder);
        color: var(--gpSurfaceText);
    }
    #gpSearchClear{
        width:28px;
        height:28px;
        border-radius:8px;
cursor:pointer;
        font-size:16px;
        line-height:1;
        background: var(--gpTintBg);
        border: 1px solid var(--gpSurfaceBorder);
        color: var(--gpSurfaceText);
    }

    #gpSearchInput:focus{
        border-color: var(--gpAccent);
        box-shadow: 0 0 0 2px var(--gpAccentSoft);
    }
    #gpSearchClear:hover{
        border-color: var(--gpAccent);
        background: var(--gpAccentSoft);
    }


    #gpSearchInput:focus{border-color:var(--gpPrimaryBg); box-shadow:0 0 0 2px rgba(0,0,0,0.06);}
    #gpSearchClear:hover{border-color:var(--gpPrimaryBg);}

    /* 2026UI: Dashboard card depth (palette-neutral) */
    :root{
        --gpCardShadowIdle: 0 2px 6px rgba(0,0,0,0.08), 0 4px 14px rgba(0,0,0,0.06);
        --gpCardShadowHover: 0 6px 18px rgba(0,0,0,0.10), 0 2px 6px rgba(0,0,0,0.06);
    }

    .gpGridCard{
        box-shadow: var(--gpCardShadowIdle);
        transition: box-shadow 140ms ease, border-color 140ms ease;
    }
    .gpGridCard:hover{
        box-shadow: var(--gpCardShadowHover);
        border-color: var(--bilmed-primary-bg, var(--gpPrimaryBg));
    }

    
    .gpGridCard.isSelected{
        border-color: var(--bilmed-primary-bg, var(--gpPrimaryBg));
    }
    .gpDelBtn{
        position:absolute;
        left:10px;
        bottom:10px;
        height:28px;
        padding:0 10px;
        border-radius:10px;
        font-size:12px;
        font-weight:700;
        cursor:pointer;
        border:1px solid rgba(200,0,0,0.35);
        background: rgba(255,255,255,0.78);
        color: rgba(200,0,0,0.92);
        display:none;
        user-select:none;
    }
    .gpDelBtn:hover{
        border-color: rgba(200,0,0,0.92);
        background: rgba(255,255,255,0.92);
    }
    .gpGridCard.isSelected .gpDelBtn{
        display:block;
    }
/* 2026UI: Unified button behavior (palette-aware) */
    .gpBtn{
        border: 1px solid var(--gpSurfaceBorder);
        background: var(--gpTintBg);
        color: var(--gpSurfaceText);
        transition: background 120ms ease, border-color 120ms ease, box-shadow 120ms ease;
    }

    .gpBtn:hover{
        border-color: var(--bilmed-primary-bg, var(--gpPrimaryBg));
        background: var(--gpTintBg);
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .gpBtn:active{
        box-shadow: 0 1px 2px rgba(0,0,0,0.10);
    }

    .gpBtn:focus-visible{
        outline: none;
        box-shadow:
            0 0 0 2px rgba(0,0,0,0.06),
            0 0 0 4px var(--bilmed-primary-bg, var(--gpPrimaryBg));
    }

    /* 2026UI: Item "buttons" (pool cards) hover */
    .gpPoolCard{
        cursor: pointer;
        transition: border-color 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    @media (hover:hover) and (pointer:fine){
        .gpPoolCard:hover{
            border-color: var(--bilmed-primary-bg, var(--gpPrimaryBg));
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            background: var(--gpTintBg);
        }
    }

    /* 2026UI: Button active (pressed) state */
    .gpBtn:active{
        background: var(--bilmed-primary-bg, var(--gpPrimaryBg));
        color: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.18) inset;
        border-color: var(--bilmed-primary-bg, var(--gpPrimaryBg));
    }


    /* Mobile responsive (<=768px): stack panels */
    @media (max-width: 768px){
        #gpTopBar{
            height: 50px;
            padding: 0 10px;
        }
        #gpTopBarTitle{
            font-size: 13px;
        }
        #gpTopBarLeft{
            min-width: 0;
            gap: 8px;
        }
        #gpTopBarRight{
            gap: 8px;
        }
        .gpBtn{
            height: 34px;
            padding: 0 10px;
            border-radius: 10px;
        }

        #gpMain{
            height: auto;
            min-height: calc(100% - 50px);
            flex-direction: column;
            gap: 10px;
            padding: 10px;
        }

        #gpPoolWrap{
            width: 100%;
            min-width: 0;
            max-width: none;
            height: 38vh;
        }

        #gpGridWrap{
            width: 100%;
            min-width: 0;
        }

        #gpGrid{
            min-height: 420px;
        }
    }


.gpPoolCard, .gpGridCard{ touch-action: none; }
#gpGridScroll{ touch-action: pan-x pan-y; }
</style>
</head>

<body>
    <div id='gpTopBar'>
        <div id='gpTopBarLeft'>
            <div id='gpTopBarTitle'>Gösterge Paneli Ayarları</div>
        </div>
        <div id='gpTopBarRight'>
            <button id='gpBtnSave' class='gpBtn'>Kaydet</button>
            <button id='gpBtnExit' class='gpBtn'>Çık</button>
        </div>
    </div>

    <div id='gpMain'>
        <div id='gpPoolWrap'>
            <div id='gpPoolHead'>
                <div class="gpSearchWrap">
                    <input id="gpSearchInput" type="text" placeholder="Ara..." />
                    <button id="gpSearchClear" title="Temizle">×</button>
                </div>
            </div>
            <div id='gpPoolList'></div>
        </div>

        <div id='gpGridWrap'>
            <div id='gpGridScroll'>
                <div id='gpGrid'>
                    <div id='gpDropHint' class='gpDropHint'></div>
                </div>
                <div id='gpSizeBox'>
                    <div id='gpSizeTitle'>Boyut</div>
                    <div class='gpSizeRow'>
                        <label for='gpSizeW'>W</label>
                        <input id='gpSizeW' type='number' min='1' max='12' step='1' inputmode='numeric'>
                        <button type='button' class='gpSizeBtn' data-size-btn='wMinus' aria-label='W azalt'>−</button>
                        <button type='button' class='gpSizeBtn' data-size-btn='wPlus' aria-label='W artır'>+</button>
                    </div>
                    <div class='gpSizeRow'>
                        <label for='gpSizeH'>H</label>
                        <input id='gpSizeH' type='number' min='1' max='12' step='1' inputmode='numeric'>
                        <button type='button' class='gpSizeBtn' data-size-btn='hMinus' aria-label='H azalt'>−</button>
                        <button type='button' class='gpSizeBtn' data-size-btn='hPlus' aria-label='H artır'>+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
'use strict';

try{ if(typeof HB_Shared !== 'undefined' && HB_Shared){ HB_Shared.DASH_GAP_PX = 16; } }catch(e){ console.error(e); }

var GP = {
    drid: 0,
    cfg: null,
    grid: [],
    poolOrder: [],
    selId: '',
    dom: {},
    drag: { active: 0, id: '', from: '' },
    touch: {
        enabled: 0,
        lpTimer: 0,
        downId: '',
        downFrom: '',
        downX: 0,
        downY: 0,
        didLongPress: 0,
        dragPointerId: -1,
        pickId: '',
        blockClickUntil: 0
    },
};


function gpIdNorm(v){ return String(v == null ? '' : v).trim(); }

function gpEsc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;'); }

function gpClampSpan(v, d){
    var n = Math.floor(Number(v));
    if(!isFinite(n)) { n = d; }
    if(n < 1) { n = 1; }
    if(n > 12) { n = 12; }
    return n;
}
function gpDomCache(){
    GP.dom.poolWrap = document.getElementById('gpPoolWrap');
    GP.dom.poolList = document.getElementById('gpPoolList');
    GP.dom.gridScroll = document.getElementById('gpGridScroll');
        GP.dom.grid = document.getElementById('gpGrid');
GP.dom.dropHint = document.getElementById('gpDropHint');
    
    GP.dom.dragImg = document.getElementById('gpDragImg');

    GP.dom.dragGhost = document.getElementById('gpDragGhost');
GP.dom.btnSave = document.getElementById('gpBtnSave');
    GP.dom.btnExit = document.getElementById('gpBtnExit');
    GP.dom.sizeBox = document.getElementById('gpSizeBox');
    GP.dom.sizeTitle = document.getElementById('gpSizeTitle');
    GP.dom.sizeW = document.getElementById('gpSizeW');
    GP.dom.sizeH = document.getElementById('gpSizeH');
}

function gpCfgKey(){
    var drid = Math.floor(Number(GP.drid) || 0);
    return 'HB.CFG.' + String(drid);
}

function gpCfgCanLoad(){
    return (typeof HB_Cfg !== 'undefined' && HB_Cfg && typeof HB_Cfg.getBlob === 'function');
}
function gpCfgCanSave(){
    return (typeof HB_Cfg !== 'undefined' && HB_Cfg && typeof HB_Cfg.saveBlob === 'function');
}

function gpGridSnapStr(){
    try{
        var out = [];
        for(var i = 0; i < GP.grid.length; i += 1){
            var g = GP.grid[i];
            if(!g) { continue; }
            out.push({ id: g.id, c: g.c, r: g.r, w: g.w, h: g.h });
        }
        return JSON.stringify(out);
    }catch(e){
        console.error(e);
        return '';
    }

    if(GP.selId){ gpGridSelect(GP.selId); }
}

function gpCfgBaselineSet(){
    GP._gridLoadedStr = gpGridSnapStr();
}

function gpCfgIsDirty(){
    var a = gpGridSnapStr();
    var b = String(GP._gridLoadedStr || '');
    return a !== b;
}



function gpCfgLoadLegacy(){
    var key = gpCfgKey();
    var raw = '';
    try{
        raw = String(localStorage.getItem(key) || '');
    }catch(e){
        console.error(e);
        raw = '';
    }
    var o = null;
    if(raw){
        try{
            o = JSON.parse(raw);
        }catch(e){
            console.error(e);
            o = null;
        }
    }
    if(!o || typeof o !== 'object') { o = {}; }
    if(!o.dash || typeof o.dash !== 'object') { o.dash = {}; }
    if(!Array.isArray(o.dash.grid)) { o.dash.grid = []; }
    GP.cfg = o;
}

function gpCfgLoad(){
    if(gpCfgCanLoad()){
        try{
            var b = HB_Cfg.getBlob(GP.drid) || {};
            GP.cfg = (b && typeof b === 'object') ? b : {};
            
            return GP.cfg;
        }catch(e){
            console.error('HB_CFG_LOAD_FAIL', e);
        }
    }else{
        console.error('HB_CFG_MISSING');
    }
    gpCfgLoadLegacy();
    
    return GP.cfg || {};
}

function gpCfgSaveLegacy(){
    var key = gpCfgKey();
    try{
        localStorage.setItem(key, JSON.stringify(GP.cfg));
    }catch(e){
        console.error(e);
    }
}

function gpCfgSave(){
    if(gpCfgCanSave()){
        try{
            HB_Cfg.saveBlob(GP.drid, GP.cfg || {});
            
            return true;
        }catch(e){
            console.error('HB_CFG_SAVE_FAIL', e);
        }
    }else{
        console.error('HB_CFG_MISSING');
    }
    gpCfgSaveLegacy();
    
    return true;
}

function gpGridLoadFromCfg(){
    var list = [];
    if(GP.cfg && GP.cfg.dash && Array.isArray(GP.cfg.dash.grid)){
        list = GP.cfg.dash.grid;
    }
    var out = [];
    var seen = {};
    for(var i = 0; i < list.length; i += 1){
        var g = list[i];
        if(!g || typeof g !== 'object') { continue; }
        var id = String(g.id || '').trim();
        if(!id) { continue; }
        if(seen[id]) { continue; }
        var it = gpCatalogGet(id);
        if(!it || !it.hasWidget) { continue; }
        var c = Math.floor(Number(g.c) || 0);
        var r = Math.floor(Number(g.r) || 0);
        if(c < 0) { c = 0; }
        if(r < 0) { r = 0; }
        var sp = gpSpanGetFromCatalog(id);
        var w = gpClampSpan((g.w != null ? g.w : sp.w), sp.w);
        var h = gpClampSpan((g.h != null ? g.h : sp.h), sp.h);
        out.push({ id: id, c: c, r: r, w: w, h: h });
        seen[id] = 1;
    }
    GP.grid = out;
}

function gpCatalogGet(id){
    if(typeof HB_ITEM_CATALOG !== 'undefined' && HB_ITEM_CATALOG){
        return HB_ITEM_CATALOG[id] || null;
    }
    return null;
}

function gpCatalogWidgetIds(){
    var ids = [];
    if(typeof HB_ITEM_CATALOG === 'undefined' || !HB_ITEM_CATALOG) { return ids; }
    for(var k in HB_ITEM_CATALOG){
        if(!Object.prototype.hasOwnProperty.call(HB_ITEM_CATALOG, k)) { continue; }
        var it = HB_ITEM_CATALOG[k];
        if(!it || !it.hasWidget) { continue; }
        ids.push(String(k));
    }
    ids.sort();
    return ids;
}


function gpPoolOrderInit(){
    var ids = gpCatalogWidgetIds();
    var inGrid = {};
    for(var i = 0; i < GP.grid.length; i += 1){
        inGrid[GP.grid[i].id] = 1;
    }
    var out = [];
    for(var j = 0; j < ids.length; j += 1){
        var id = ids[j];
        if(inGrid[id]) { continue; }
        out.push(id);
    }
    GP.poolOrder = out;
}

function gpPoolOrderRemove(id){
    id = gpIdNorm(id);
    if(!id) { return; }
    for(var i = 0; i < GP.poolOrder.length; i += 1){
        if(gpIdNorm(GP.poolOrder[i]) === id){
            GP.poolOrder.splice(i, 1);
            return;
        }
    }
}

function gpPoolOrderAppend(id){
    id = gpIdNorm(id);
    if(!id) { return; }
    gpPoolOrderRemove(id);
    GP.poolOrder.push(id);
}


function gpSpanGetFromCatalog(id){
    var it = gpCatalogGet(id);
    var w = 1;
    var h = 1;
    if(it){
        w = gpClampSpan(it.dashSpanW, 1);
        h = gpClampSpan(it.dashSpanH, 1);
    }
    w = gpClampSpan(w, 1);
    h = gpClampSpan(h, 1);
    return { w: w, h: h };
}

function gpSpanGet(id){
    id = gpIdNorm(id);
    if(id){
        for(var i = 0; i < GP.grid.length; i += 1){
            var g = GP.grid[i];
            if(!g) { continue; }
            if(g.id === id){
                var w = gpClampSpan(g.w, 1);
                var h = gpClampSpan(g.h, 1);
                return { w:w, h:h };
            }
        }
    }
    return gpSpanGetFromCatalog(id);
}

function gpIconSvgGet(id){
    var it = gpCatalogGet(id);
    if(it && it.icon && typeof it.icon === 'string'){
        return it.icon;
    }
    return '';
}

function gpIconHtmlGet(id){
    var it = gpCatalogGet(id) || {};
    var raw = '';

    if(it.iconSvg && typeof it.iconSvg === 'string'){ raw = it.iconSvg; }
    else if(it.svg && typeof it.svg === 'string'){ raw = it.svg; }
    else if(it.icon && typeof it.icon === 'string'){ raw = it.icon; }
    else if(it.iconKey && typeof it.iconKey === 'string'){ raw = it.iconKey; }
    else if(it.iconName && typeof it.iconName === 'string'){ raw = it.iconName; }

    if(!raw && typeof it.icon === 'function'){
        try{
            raw = String(it.icon(id) || '');
        }catch(e){
            console.error(e);
            raw = '';
        }
    }else if(!raw && it.icon && typeof it.icon === 'object'){
        if(it.icon.svg && typeof it.icon.svg === 'string'){ raw = it.icon.svg; }
        else if(it.icon.html && typeof it.icon.html === 'string'){ raw = it.icon.html; }
        else if(it.icon.key && typeof it.icon.key === 'string'){ raw = it.icon.key; }
        else if(it.icon.name && typeof it.icon.name === 'string'){ raw = it.icon.name; }
    }

    raw = String(raw || '').trim();
    if(!raw){
        try{ console.warn('GP_ICON_MISS_EMPTY', id); }catch(_e){}
        return '';
    }

    if(raw.indexOf('<svg') >= 0 || raw.indexOf('<path') >= 0 || raw.indexOf('<g') >= 0){
        return raw;
    }

    var key = raw;

    if(typeof __hb_svgIcons !== 'undefined' && __hb_svgIcons){
        if(typeof __hb_svgIcons === 'function'){
            try{
                var v1 = __hb_svgIcons(key);
                if(v1){ return String(v1); }
            }catch(e){
                console.error(e);
            }
        }else if(__hb_svgIcons[key]){
            return String(__hb_svgIcons[key] || '');
        }
    }
    if(typeof HB_SVG_ICONS !== 'undefined' && HB_SVG_ICONS && HB_SVG_ICONS[key]){
        return String(HB_SVG_ICONS[key] || '');
    }
    if(typeof HB_ItemCatalog_Icons !== 'undefined' && HB_ItemCatalog_Icons && HB_ItemCatalog_Icons[key]){
        return String(HB_ItemCatalog_Icons[key] || '');
    }

    try{ console.warn('GP_ICON_MISS_KEY', id, key); }catch(_e){}
    return '';
}


function gpPoolRender(){
    GP.dom.poolList.innerHTML = '';
    for(var j = 0; j < GP.poolOrder.length; j += 1){
        var id = GP.poolOrder[j];
        GP.dom.poolList.appendChild(gpPoolCardEl(id));
    }
}

function gpPoolCardEl(id){
    var it = gpCatalogGet(id) || {};
    var el = document.createElement('div');
    el.className = 'gpPoolCard';
    el.setAttribute('draggable', 'true');
    el.dataset.id = id;
    el.addEventListener('dragstart', gpOnDragStart);
    el.addEventListener('dragend', gpOnDragEnd);

    var icon = document.createElement('div');
    icon.className = 'gpPoolIcon';
    icon.innerHTML = gpIconHtmlGet(id) || '';
    el.appendChild(icon);

    var txt = document.createElement('div');
    txt.className = 'gpPoolText';
    var t1 = document.createElement('div');
    t1.className = 'gpPoolTitle';
    t1.textContent = String(it.title || id);
    txt.appendChild(t1);

    var t2 = document.createElement('div');
    t2.className = 'gpPoolDesc';
    t2.textContent = String(it.desc || '');
    txt.appendChild(t2);

    el.appendChild(txt);
    return el;
}

function gpGridPadGet(){
    if(!GP.dom || !GP.dom.gridScroll) { return { l: 0, r: 0, t: 0, b: 0 }; }
    var cs = getComputedStyle(GP.dom.gridScroll);
    var pl = parseFloat(cs.paddingLeft) || 0;
    var pr = parseFloat(cs.paddingRight) || 0;
    var pt = parseFloat(cs.paddingTop) || 0;
    var pb = parseFloat(cs.paddingBottom) || 0;
    return { l: pl, r: pr, t: pt, b: pb };
}

function gpGeomGet(){
    var mode = hbModeGet();
    var gap = hbDashGapPxGet();
    var pad = gpGridPadGet();
    var availW = GP.dom.gridScroll.clientWidth - pad.l - pad.r;
    if(availW < 1) { availW = 1; }
    var cols = hbDashGridColsGet(mode, availW);
    if(cols < 1) { cols = 1; }
    var unit = (availW - (gap * (cols - 1))) / cols;
    if(!isFinite(unit) || unit <= 1) { unit = 1; }
    var _u = (GP && GP._unit != null) ? Number(GP._unit) : NaN;
    if(isFinite(_u) && _u >= 1) { unit = _u; }
    var step = unit + gap;
    var rect = GP.dom.gridScroll.getBoundingClientRect();
    return { mode: mode, gap: gap, pad: pad, availW: availW, cols: cols, unit: unit, step: step, rect: rect };
}

function gpGridLayoutApply(){
    var g = gpGeomGet();
    var unit = Math.round(Number(g.unit) || 0);
    if(!isFinite(unit) || unit < 1){ unit = 1; }
    document.documentElement.style.setProperty('--gpUnitPx', String(unit) + 'px');
    document.documentElement.style.setProperty('--gpGap', String(g.gap) + 'px');
    GP.dom.grid.style.gridTemplateColumns = 'repeat(' + String(g.cols) + ', ' + String(unit) + 'px)';
    GP.dom.grid.style.gridAutoRows = String(unit) + 'px';
    GP.dom.grid.style.width = String((g.cols * unit) + (g.gap * (g.cols - 1))) + 'px';
    GP._cols = g.cols;
    GP._unit = unit;
    GP._gap = g.gap;
}

function gpGridRender(){
    gpGridLayoutApply();
    GP.dom.dropHint.style.display = 'none';
    GP.dom.grid.innerHTML = '';
    GP.dom.grid.appendChild(GP.dom.dropHint);

    for(var i = 0; i < GP.grid.length; i += 1){
        var g = GP.grid[i];
        if(!g) { continue; }
        GP.dom.grid.appendChild(gpGridCardEl(g.id, g.c, g.r));
    }
}

function gpGridCardEl(id, c, r){
    var it = gpCatalogGet(id) || {};
    var sp = gpSpanGet(id);

    var el = document.createElement('div');
    el.className = 'gpGridCard';
    el.setAttribute('draggable', 'true');
    el.dataset.id = id;

    if(gpIdNorm(GP.selId) === id){ el.classList.add('isSelected'); }

    el.style.gridColumnStart = String(c + 1);
    el.style.gridRowStart = String(r + 1);
    el.style.gridColumnEnd = 'span ' + String(sp.w);
    el.style.gridRowEnd = 'span ' + String(sp.h);

    el.addEventListener('dragstart', gpOnDragStart);
    el.addEventListener('dragend', gpOnDragEnd);

    el.addEventListener('click', gpOnGridCardClick);

    var inner = document.createElement('div');
    inner.className = 'gpGridCardInner';

    var icon = document.createElement('div');
    icon.className = 'gpGridIcon';
    icon.innerHTML = gpIconHtmlGet(id) || '';
    inner.appendChild(icon);

    var tt = document.createElement('div');
    tt.className = 'gpGridTitle';
    tt.textContent = String(it.title || id);
    inner.appendChild(tt);

    var dd = document.createElement('div');
    dd.className = 'gpGridDesc';
    dd.textContent = String(it.desc || '');
    inner.appendChild(dd);

    el.appendChild(inner);

    var del = document.createElement('button');
    del.className = 'gpDelBtn';
    del.type = 'button';
    del.textContent = 'Sil';
    del.dataset.id = id;
    del.addEventListener('click', gpOnGridCardDeleteClick);
    el.appendChild(del);

    return el;
}


function gpGridSelect(id){
    id = gpIdNorm(id);
    if(id && GP.touch){
        GP.touch.pickId = '';
        try{
            var pcards = GP.dom && GP.dom.poolList ? GP.dom.poolList.querySelectorAll('.gpPoolCard') : null;
            if(pcards){
                for(var pi = 0; pi < pcards.length; pi += 1){
                    var pe = pcards[pi];
                    if(!pe || !pe.classList) { continue; }
                    pe.classList.remove('isPicked');
                }
            }
        }catch(e){ console.error(e); }
    }
    GP.selId = id;
    var kids = GP.dom.grid.children;
    for(var i = 0; i < kids.length; i += 1){
        var el = kids[i];
        if(!el || !el.classList || !el.dataset) { continue; }
        if(!el.classList.contains('gpGridCard')) { continue; }
        el.classList.toggle('isSelected', gpIdNorm(el.dataset.id) === id);
    }
    gpSizeUiSync();
}

function gpSelObjGet(){
    var id = gpIdNorm(GP.selId);
    if(!id) { return null; }
    var idx = gpGridFindIndex(id);
    if(idx < 0) { return null; }
    return GP.grid[idx] || null;
}

function gpSizeUiSync(){
    if(!GP.dom || !GP.dom.sizeBox || !GP.dom.sizeW || !GP.dom.sizeH || !GP.dom.sizeTitle){ return; }
    var g = gpSelObjGet();
    if(!g){
        GP.dom.sizeBox.classList.add('isDisabled');
        GP.dom.sizeTitle.textContent = 'Boyut';
        GP.dom.sizeW.value = '';
        GP.dom.sizeH.value = '';
        GP.dom.sizeW.disabled = true;
        GP.dom.sizeH.disabled = true;
        return;
    }
    var it = gpCatalogGet(g.id) || {};
    GP.dom.sizeBox.classList.remove('isDisabled');
    GP.dom.sizeTitle.textContent = String(it.title || g.id);
    GP.dom.sizeW.disabled = false;
    GP.dom.sizeH.disabled = false;
    GP.dom.sizeW.value = String(Math.floor(Number(g.w) || 1));
    GP.dom.sizeH.value = String(Math.floor(Number(g.h) || 1));
}

function gpSizeClamp(v){
    var n = Math.floor(Number(v) || 0);
    if(n < 1) { n = 1; }
    if(n > 12) { n = 12; }
    return n;
}

function gpOnSizeInputChange(){
    var g = gpSelObjGet();
    if(!g){ gpSizeUiSync(); return; }
    var w = gpSizeClamp(GP.dom.sizeW.value);
    var h = gpSizeClamp(GP.dom.sizeH.value);
    var oldW = Math.floor(Number(g.w) || 1);
    var oldH = Math.floor(Number(g.h) || 1);
    if(w === oldW && h === oldH){ gpSizeUiSync(); return; }
    g.w = w;
    g.h = h;
    if(!gpGridCanPlaceAt(g.id, g.c, g.r)){
        g.w = oldW;
        g.h = oldH;
        gpSizeUiSync();
        return;
    }
    gpCfgSyncGridMem();
    gpRenderAll();
    gpGridSelect(g.id);
}

function gpOnSizeBtnClick(e){
    try{
        if(e && e.preventDefault){ e.preventDefault(); }
        var btn = e && e.currentTarget ? e.currentTarget : null;
        if(!btn || !btn.getAttribute) { return; }
        var k = String(btn.getAttribute('data-size-btn') || '');
        if(!k) { return; }
        var g = gpSelObjGet();
        if(!g){ gpSizeUiSync(); return; }
        var w = Math.floor(Number(g.w) || 1);
        var h = Math.floor(Number(g.h) || 1);
        if(k === 'wMinus') { w -= 1; }
        if(k === 'wPlus') { w += 1; }
        if(k === 'hMinus') { h -= 1; }
        if(k === 'hPlus') { h += 1; }
        w = gpSizeClamp(w);
        h = gpSizeClamp(h);
        var oldW = Math.floor(Number(g.w) || 1);
        var oldH = Math.floor(Number(g.h) || 1);
        if(w === oldW && h === oldH){ gpSizeUiSync(); return; }
        g.w = w;
        g.h = h;
        if(!gpGridCanPlaceAt(g.id, g.c, g.r)){
            g.w = oldW;
            g.h = oldH;
            gpSizeUiSync();
            return;
        }
        gpCfgSyncGridMem();
        gpRenderAll();
        gpGridSelect(g.id);
    }catch(err){ console.error(err); }
}

function gpOnGridCardClick(e){
    if(GP.drag && GP.drag.active) { return; }
    var id = gpIdNorm(e.currentTarget && e.currentTarget.dataset ? e.currentTarget.dataset.id : '');
    if(!id) { return; }
    gpGridSelect(id);
}

function gpOnGridCardDeleteClick(e){
    e.preventDefault();
    e.stopPropagation();
    try{
        if(GP && GP._blockDeleteUntil && Date.now() < GP._blockDeleteUntil){
            return;
        }
    }catch(_e){ }
    var id = gpIdNorm(e.currentTarget && e.currentTarget.dataset ? e.currentTarget.dataset.id : '');
    if(!id) { return; }
    gpGridRemove(id);
    gpPoolOrderAppend(id);
    gpCfgSyncGridMem();
    if(GP.selId === id){ GP.selId = ''; }
    gpRenderAll();
}


function gpOnDragStart(e){
    var id = gpIdNorm(e.currentTarget && e.currentTarget.dataset ? e.currentTarget.dataset.id : '');
    if(!id) { return; }
    GP.drag.active = 1;
    GP.drag.id = id;
    GP.drag.fromIndex = gpGridFindIndex(id);
    GP.drag.from = GP.drag.fromIndex >= 0 ? 'grid' : 'pool';

    try{
        var rr = e.currentTarget && e.currentTarget.getBoundingClientRect ? e.currentTarget.getBoundingClientRect() : null;
        if(rr){
            GP.drag.grabDx = e.clientX - rr.left;
            GP.drag.grabDy = e.clientY - rr.top;
        }else{
            GP.drag.grabDx = 0;
            GP.drag.grabDy = 0;
        }
        var gg = gpGeomGet();
        var sp = gpSpanGet(id);
        GP.drag.pxW = (sp.w * gg.unit) + ((sp.w - 1) * gg.gap);
        GP.drag.pxH = (sp.h * gg.unit) + ((sp.h - 1) * gg.gap);
    }catch(_e){
        GP.drag.grabDx = 0; GP.drag.grabDy = 0; GP.drag.pxW = 0; GP.drag.pxH = 0;
    }

    gpDragGhostShow(id);
    gpDragGhostMove(e.clientX, e.clientY);

    try{
        e.dataTransfer.setData('text/plain', id);
        e.dataTransfer.effectAllowed = 'move';
        if(GP.dom && GP.dom.dragImg){
            e.dataTransfer.setDragImage(GP.dom.dragImg, 0, 0);
        }
    }catch(err){
        console.error(err);
    }
}

function gpOnDragEnd(){
    GP.drag.active = 0;
    GP.drag.id = '';
    GP.drag.from = '';
    gpDropHintHide();
}

function gpTouchLpClear(){
    if(GP.touch && GP.touch.lpTimer){
        try{ clearTimeout(GP.touch.lpTimer); }catch(e){}
    }
    GP.touch.lpTimer = 0;
    GP.touch.downId = '';
    GP.touch.downFrom = '';
    GP.touch.downX = 0;
    GP.touch.downY = 0;
    GP.touch.didLongPress = 0;
}

function gpTouchIsActive(){
    try{
        if(window.matchMedia && window.matchMedia('(pointer:coarse)').matches){ return 1; }
    }catch(e){}
    return ('ontouchstart' in window) ? 1 : 0;
}

function gpTouchPickSet(id){
    if(id && GP.selId){
        GP.selId = '';
        try{
            var gkids = GP.dom && GP.dom.grid ? GP.dom.grid.children : null;
            if(gkids){
                for(var gi = 0; gi < gkids.length; gi += 1){
                    var ge = gkids[gi];
                    if(!ge || !ge.classList || !ge.classList.contains('gpGridCard')) { continue; }
                    ge.classList.remove('isSelected');
                }
            }
        }catch(e){ console.error(e); }
        gpSizeUiSync();
    }
    GP.touch.pickId = gpIdNorm(id);
    try{
        var cards = GP.dom && GP.dom.poolList ? GP.dom.poolList.querySelectorAll('.gpPoolCard') : null;
        if(cards){
            for(var i = 0; i < cards.length; i += 1){
                var c = cards[i];
                if(!c || !c.classList || !c.dataset) { continue; }
                c.classList.toggle('isPicked', gpIdNorm(c.dataset.id) === GP.touch.pickId);
            }
        }
    }catch(e){ console.error(e); }
}

function gpTouchDragStart(ev, id, from){
    id = gpIdNorm(id);
    if(!id) { return; }
    GP.drag.active = 1;
    GP.drag.id = id;
    GP.drag.fromIndex = gpGridFindIndex(id);
    GP.drag.from = from || (GP.drag.fromIndex >= 0 ? 'grid' : 'pool');
    try{
        GP.dom && GP.dom.grid && GP.dom.grid.classList ? GP.dom.grid.classList.add('isTouchDragging') : 0;
    }catch(e){}

    try{
        var rr = ev.currentTarget && ev.currentTarget.getBoundingClientRect ? ev.currentTarget.getBoundingClientRect() : null;
        if(rr){
            GP.drag.grabDx = ev.clientX - rr.left;
            GP.drag.grabDy = ev.clientY - rr.top;
        }else{
            GP.drag.grabDx = 0;
            GP.drag.grabDy = 0;
        }
        var gg = gpGeomGet();
        var sp = gpSpanGet(id);
        GP.drag.pxW = (sp.w * gg.unit) + ((sp.w - 1) * gg.gap);
        GP.drag.pxH = (sp.h * gg.unit) + ((sp.h - 1) * gg.gap);
    }catch(_e){
        GP.drag.grabDx = 0; GP.drag.grabDy = 0; GP.drag.pxW = 0; GP.drag.pxH = 0;
    }

    gpDragGhostShow(id);
    gpDragGhostMove(ev.clientX, ev.clientY);
}

function gpTouchDragMove(ev){
    if(!GP.drag.active) { return; }
    gpDragGhostMove(ev.clientX, ev.clientY);
    var id = gpIdNorm(GP.drag.id);
    if(!id) { return; }
    var p = gpGridCellFromEvent({ clientX: ev.clientX, clientY: ev.clientY }, id);
    if(p.c < 0 || p.r < 0) {
        gpDropHintHide();
        return;
    }
    var ok = gpGridCanPlaceAt(id, p.c, p.r);
    gpDropHintShow(id, p.c, p.r, ok);
}

function gpTouchDragEnd(ev){
    if(!GP.drag.active) { return; }
    var id = gpIdNorm(GP.drag.id);
    if(!id) { gpOnDocDragEnd(ev); return; }

    var p = gpGridCellFromEvent({ clientX: ev.clientX, clientY: ev.clientY }, id);
    if(p.c >= 0 && p.r >= 0 && gpGridCanPlaceAt(id, p.c, p.r)){
        if(GP.drag.from === 'pool'){ gpPoolOrderRemove(id); }
        gpGridUpsert(id, p.c, p.r);
        gpCfgSyncGridMem();
        gpRenderAll();
        gpGridSelect(id);
        gpTouchPickSet('');
        gpOnDocDragEnd(ev);
        return;
    }

    if(GP.drag.from === 'grid'){
        var overPool = 0;
        try{
            var t = document.elementFromPoint(ev.clientX, ev.clientY);
            while(t){
                if(t === GP.dom.poolWrap){ overPool = 1; break; }
                t = t.parentNode;
            }
        }catch(e){}
        if(overPool){
            gpGridRemove(id);
            gpPoolOrderAppend(id);
            gpCfgSyncGridMem();
            if(GP.selId === id){ GP.selId = ''; }
            gpRenderAll();
            gpTouchPickSet('');
            gpOnDocDragEnd(ev);
            return;
        }
    }

    gpOnDocDragEnd(ev);
}

function gpTouchOnPointerDown(ev){
    try{
        if(!GP.touch.enabled) { return; }
        if(!ev || ev.pointerType !== 'touch') { return; }
        if(GP.drag && GP.drag.active) { return; }

        var el = ev.target;
        var from = '';
        while(el){
            if(el.classList && el.classList.contains('gpPoolCard')) { from = 'pool'; break; }
            if(el.classList && el.classList.contains('gpGridCard')) { from = 'grid'; break; }
            if(el === GP.dom.poolWrap || el === GP.dom.gridScroll || el === document.body) { break; }
            el = el.parentNode;
        }
        if(!from || !el || !el.dataset) { return; }
        var id = gpIdNorm(el.dataset.id);
        if(!id) { return; }

        try{ if(el && el.setPointerCapture){ el.setPointerCapture(ev.pointerId); } }catch(e){}
        try{ ev.preventDefault(); }catch(e){}

        if(from === 'pool'){
            var prevPick = gpIdNorm(GP.touch.pickId);
            if(prevPick && prevPick !== id){
                gpTouchPickSet('');
            }
        }
        gpTouchLpClear();
        GP.touch.downId = id;
        GP.touch.downFrom = from;
        GP.touch.downX = Number(ev.clientX || 0);
        GP.touch.downY = Number(ev.clientY || 0);
        GP.touch.didLongPress = 0;
        GP.touch.dragArmed = 0;
        if(from === 'pool'){
            gpTouchPickSet(id);
            gpGridSelect('');
            GP.touch.dragArmed = 1;
        }else if(from === 'grid'){
            gpGridSelect(id);
            gpTouchPickSet('');
            GP.touch.dragArmed = 1;
        }

        GP.touch.lpTimer = setTimeout(function(){
            GP.touch.lpTimer = 0;
            var did = gpIdNorm(GP.touch.downId);
            var dfrom = String(GP.touch.downFrom || '');
            if(!did || !dfrom) { return; }
            if(dfrom === 'grid'){
                gpGridSelect(did);
                gpTouchPickSet('');
            }else if(dfrom === 'pool'){
                gpTouchPickSet(did);
                gpGridSelect('');
            }
            GP.touch.didLongPress = 1;
            GP.touch.blockClickUntil = Date.now() + 700;
            GP.touch.dragPointerId = ev.pointerId;
            try{ if(ev.target && ev.target.setPointerCapture){ ev.target.setPointerCapture(ev.pointerId); } }catch(e){}
            gpTouchDragStart(ev, did, dfrom);
        }, 450);
    }catch(e){ console.error(e); }
}

function gpTouchOnPointerMove(ev){
    try{
        if(!GP.touch.enabled) { return; }
        if(!ev || ev.pointerType !== 'touch') { return; }
        if(GP.drag && GP.drag.active){ try{ ev.preventDefault(); }catch(e){} gpTouchDragMove(ev); return; }
        if(!GP.touch.downFrom){ return; }
        try{ ev.preventDefault(); }catch(e){}

        var sx = Number(GP.touch.downX || 0);
        var sy = Number(GP.touch.downY || 0);
        var dx = Number(ev.clientX || 0) - sx;
        var dy = Number(ev.clientY || 0) - sy;
        if((dx*dx + dy*dy) > 120){
            var did = gpIdNorm(GP.touch.downId);
            var dfrom = String(GP.touch.downFrom || '');
            if(GP.touch.dragArmed && did && dfrom){
                gpTouchLpClear();
                GP.touch.blockClickUntil = Date.now() + 700;
                GP.touch.dragPointerId = ev.pointerId;
                try{ if(ev.target && ev.target.setPointerCapture){ ev.target.setPointerCapture(ev.pointerId); } }catch(e){}
                gpTouchDragStart(ev, did, dfrom);
                return;
            }
            if(GP.touch.lpTimer){
                gpTouchLpClear();
            }
        }
    }catch(e){ console.error(e); }
}

function gpTouchOnPointerUp(ev){
    try{
        if(!GP.touch.enabled) { return; }
        if(!ev || ev.pointerType !== 'touch') { return; }
        if(GP.drag && GP.drag.active){ try{ ev.preventDefault(); }catch(e){} 
            gpTouchLpClear();
            gpTouchDragEnd(ev);
            return;
        }

        if(!GP.touch.downFrom){ gpTouchLpClear(); return; }
        try{ ev.preventDefault(); }catch(e){}

        var from = String(GP.touch.downFrom || '');
        var id = gpIdNorm(GP.touch.downId);
        var hadTimer = !!GP.touch.lpTimer;
        gpTouchLpClear();
        if(!hadTimer || !id || !from){ return; }

        if(from === 'pool'){
            gpTouchPickSet(id);
            return;
        }
        if(from === 'grid'){
            gpGridSelect(id);
            return;
        }
    }catch(e){ console.error(e); }
}

function gpTouchOnGridTap(ev){
    try{
        if(!GP.touch.enabled) { return; }
        if(!ev || ev.pointerType !== 'touch') { return; }
        try{ ev.preventDefault(); }catch(e){}
        if(GP.drag && GP.drag.active) { return; }
        var pickId = gpIdNorm(GP.touch.pickId);
        if(!pickId) { return; }
        var p = gpGridCellFromEvent({ clientX: ev.clientX, clientY: ev.clientY }, pickId);
        if(p.c < 0 || p.r < 0) { return; }
        if(!gpGridCanPlaceAt(pickId, p.c, p.r)) { return; }
        gpPoolOrderRemove(pickId);
        gpGridUpsert(pickId, p.c, p.r);
        gpCfgSyncGridMem();
        try{ GP._blockDeleteUntil = Date.now() + 600; }catch(_e){ }
        gpRenderAll();
        gpGridSelect(pickId);
        gpTouchPickSet('');
    }catch(e){ console.error(e); }
}

function gpOnPoolDragOver(e){
    if(!GP.drag.active) { return; }
    if(GP.drag.from !== 'grid') { return; }
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function gpOnPoolDrop(e){
    if(!GP.drag.active) { return; }
    if(GP.drag.from !== 'grid') { return; }
    var id = gpIdNorm(GP.drag.id);
    if(!id) { return; }
    e.preventDefault();
    gpGridRemove(id);
    gpPoolOrderAppend(id);
    gpCfgSyncGridMem();
    if(GP.selId === id){ GP.selId = ''; }
    gpRenderAll();
    gpOnDocDragEnd(e);
}

function gpOnGridDragEnter(e){
    if(!GP.drag.active) { return; }
    e.preventDefault();
}

function gpOnGridDragLeave(){
    gpDropHintHide();
}

function gpOnGridDragOver(e){
    if(!GP.drag.active) { return; }
    var id = gpIdNorm(GP.drag.id);
    if(!id) { return; }

    var p = gpGridCellFromEvent(e, id);
    if(p.c < 0 || p.r < 0) {
        gpDropHintHide();
        return;
    }

    var ok = gpGridCanPlaceAt(id, p.c, p.r);

    gpDropHintShow(id, p.c, p.r, ok);

    if(ok){
        e.preventDefault();
    }
}

function gpOnGridDrop(e){
    
        
if(!GP.drag.active) { return; }
    var id = gpIdNorm(GP.drag.id);
    if(!id) { return; }
    var p = gpGridCellFromEvent(e, id);
    if(p.c < 0 || p.r < 0) { return; }
    if(!gpGridCanPlaceAt(id, p.c, p.r)) { return; }
    e.preventDefault();
    if(GP.drag.from === 'pool'){ gpPoolOrderRemove(id); }
    gpGridUpsert(id, p.c, p.r);
    gpCfgSyncGridMem();
    gpRenderAll();
    gpOnDocDragEnd(e);
}


function gpGridNormalizeAll(){
    for(var i=0;i<GP.grid.length;i+=1){
        var g=GP.grid[i];
        if(!g) { continue; }
        g.w = gpClampSpan(g.w, 1);
        g.h = gpClampSpan(g.h, 1);
    }
}

function gpGridFindIndex(id){
    id = gpIdNorm(id);
    for(var i = 0; i < GP.grid.length; i += 1){
        if(GP.grid[i] && gpIdNorm(GP.grid[i].id) === id) { return i; }
    }
    return -1;
}

function gpGridRemove(id){
    id = gpIdNorm(id);
    var idx = gpGridFindIndex(id);
    if(idx < 0) { return; }
    GP.grid.splice(idx, 1);
}

function gpGridUpsert(id, c, r){
    id = gpIdNorm(id);
    var idx = gpGridFindIndex(id);
    var sp = gpSpanGetFromCatalog(id);
    var g = { id: id, c: c, r: r, w: sp.w, h: sp.h };
    if(idx >= 0){
        var prev = GP.grid[idx];
        if(prev && typeof prev === 'object'){
            g.w = gpClampSpan(prev.w, g.w);
            g.h = gpClampSpan(prev.h, g.h);
        }
        g.w = gpClampSpan(g.w, 1);
        g.h = gpClampSpan(g.h, 1);
        GP.grid[idx] = g;
        return;
    }
    g.w = gpClampSpan(g.w, 1);
        g.h = gpClampSpan(g.h, 1);
    GP.grid.push(g);
}

function gpGridOccBuild(exceptId){
    var occ = {};
    for(var i = 0; i < GP.grid.length; i += 1){
        var g = GP.grid[i];
        if(!g) { continue; }
        if(exceptId && g.id === exceptId) { continue; }
        var sp = gpSpanGet(g.id);
        for(var rr = 0; rr < sp.h; rr += 1){
            for(var cc = 0; cc < sp.w; cc += 1){
                var k = String(g.c + cc) + ':' + String(g.r + rr);
                occ[k] = 1;
            }
        }
    }
    return occ;
}

function gpGridCanPlaceAt(id, c, r){
    var g = gpGeomGet();
    var cols = g.cols;
var sp = gpSpanGet(id);

    if(c < 0 || r < 0) { return 0; }
    if(c + sp.w > cols) { return 0; }

    var occ = gpGridOccBuild(id);
    for(var rr = 0; rr < sp.h; rr += 1){
        for(var cc = 0; cc < sp.w; cc += 1){
            var k = String(c + cc) + ':' + String(r + rr);
            if(occ[k]) { return 0; }
        }
    }
    return 1;
}

function gpGridCellFromEvent(e, id){
    if(!GP.dom || !GP.dom.grid || !GP.dom.gridScroll) { return { c: -1, r: -1 }; }

    var g = gpGeomGet();

    var ax = e.clientX;
    var ay = e.clientY;

    var x = ax - g.rect.left - g.pad.l + GP.dom.gridScroll.scrollLeft;
    var y = ay - g.rect.top - g.pad.t + GP.dom.gridScroll.scrollTop;

    if(x < 0 || y < 0) { return { c: -1, r: -1 }; }

    var step = g.step;
    if(!isFinite(step) || step <= 0) { step = 1; }

    var c0 = Math.floor((x + (g.unit * 0.5)) / step);
    var r0 = Math.floor((y + (g.unit * 0.5)) / step);

    var sp = gpSpanGet(id);

    var best = { c: -1, r: -1, d: 0 };
    var hasBest = 0;

    var cand = [
        { c: c0, r: r0 },
        { c: c0 - 1, r: r0 },
        { c: c0, r: r0 - 1 },
        { c: c0 - 1, r: r0 - 1 },
    ];

    for(var i = 0; i < cand.length; i += 1){
        var cc = cand[i].c;
        var rr = cand[i].r;

        if(cc < 0 || rr < 0) { continue; }
        if(cc >= g.cols) { continue; }
        if(cc + sp.w > g.cols) { continue; }

        var cx = (cc * step) + (g.unit * 0.5);
        var cy = (rr * step) + (g.unit * 0.5);

        var dx = x - cx;
        var dy = y - cy;
        var d2 = (dx * dx) + (dy * dy);

        if(!hasBest || d2 < best.d){
            best.c = cc;
            best.r = rr;
            best.d = d2;
            hasBest = 1;
        }
    }

    if(!hasBest) { return { c: -1, r: -1 }; }
    return { c: best.c, r: best.r };
}




function gpDragGhostShow(id){
    id = gpIdNorm(id);
    if(!GP.dom || !GP.dom.dragGhost) { return; }
    var it = gpItemGet(id);
    var sp = gpSpanGet(id);
    var title = it ? (it.title || it.text || it.id || id) : id;
    GP.dom.dragGhost.innerHTML =
        '<div class="gpDragGhostRow">' +
            '<div class="gpDragGhostIcon">⧉</div>' +
            '<div class="gpDragGhostText">' +
                '<div class="gpDragGhostTitle">' + gpEsc(title) + '</div>' +
                '<div class="gpDragGhostMeta">' + String(sp.w) + '×' + String(sp.h) + '</div>' +
            '</div>' +
        '</div>';
    GP.dom.dragGhost.style.display = 'block';
}
function gpDragGhostMove(clientX, clientY){
    if(!GP.dom || !GP.dom.dragGhost) { return; }
    var x = clientX + 16;
    var y = clientY + 16;
    GP.dom.dragGhost.style.transform = 'translate(' + String(x) + 'px,' + String(y) + 'px)';
}
function gpDragGhostHide(){
    if(!GP.dom || !GP.dom.dragGhost) { return; }
    GP.dom.dragGhost.style.display = 'none';
    GP.dom.dragGhost.style.transform = 'translate(-10000px,-10000px)';
}

function gpDropHintShow(id, c, r, ok){
    var g = gpGeomGet();
    var sp = gpSpanGet(id);

    var left = c * g.step;
    var top = r * g.step;
    var w = sp.w * g.unit + (sp.w - 1) * g.gap;
    var h = sp.h * g.unit + (sp.h - 1) * g.gap;

    GP.dom.dropHint.style.left = String(left) + 'px';
    GP.dom.dropHint.style.top = String(top) + 'px';
    GP.dom.dropHint.style.width = String(w) + 'px';
    GP.dom.dropHint.style.height = String(h) + 'px';
    GP.dom.dropHint.style.display = 'block';
    GP.dom.dropHint.classList.toggle('valid', !!ok);
    GP.dom.dropHint.classList.toggle('invalid', !ok);
}

function gpDropHintHide(){
    GP.dom.dropHint.style.display = 'none';

    GP.dom.dropHint.classList.remove('valid');
    GP.dom.dropHint.classList.remove('invalid');
}

function gpRenderAll(){
    gpGridRender();
        
    gpPoolRender();
}

function gpCfgSyncGridMem(){
    try{
        if(!GP.cfg) { return; }
        if(!GP.cfg.dash) { GP.cfg.dash = {}; }
        var out = [];
        for(var i = 0; i < GP.grid.length; i += 1){
            var g = GP.grid[i];
            if(!g) { continue; }
            out.push({ id: g.id, c: g.c, r: g.r, w: g.w, h: g.h });
        }
        GP.cfg.dash.grid = out;
    }catch(e){ console.error(e); }
}

function gpSave(){
    var out = [];
    for(var i = 0; i < GP.grid.length; i += 1){
        var g = GP.grid[i];
        if(!g) { continue; }
        out.push({ id: g.id, c: g.c, r: g.r, w: g.w, h: g.h });
    }
    GP.cfg.dash.grid = out;
    gpCfgSave();
    gpCfgBaselineSet();
}

function gpExit(){
    if(gpCfgIsDirty()){
        if(!confirm('Kaydedilmemiş değişiklikler var. Çıkılsın mı?')){ return; }
    }
    window.location.href = 'DrHastaBasi.html';
}

    function gpGhostShow(c, r, spanW, spanH){
        if(!GP.dom.gridGhost){ return; }
        GP.dom.grid.classList.add('isDragging');
        GP.dom.gridGhost.style.gridColumn = (c + 1) + ' / span ' + spanW;
        GP.dom.gridGhost.style.gridRow = (r + 1) + ' / span ' + spanH;
    }

    function gpGhostHide(){
        if(!GP.dom.gridGhost){ return; }
        GP.dom.grid.classList.remove('isDragging');
    }
    
        function gpGhostAbsHide(){
        if(!GP.dom.ghostAbs){ return; }
        GP.dom.grid.classList.remove('isDragging');
    }

    
    


function gpOnDocDragOver(e){
    if(!GP.drag.active) { return; }
    gpDragGhostMove(e.clientX, e.clientY);
}
function gpOnDocDragEnd(e){
    if(!GP.drag.active) { return; }
    GP.drag.active = 0;
    GP.drag.id = '';
    GP.drag.from = '';
    GP.drag.fromIndex = -1;
    gpDropHintHide();
    gpDragGhostHide();
}


function gpParamGet(k){
    try{
        var u = new URL(window.location.href);
        return u.searchParams.get(k) || '';
    }catch(e){
        try{
            var qs = String(window.location.search || '').replace(/^\?/, '');
            var parts = qs.split('&');
            for(var i = 0; i < parts.length; i += 1){
                var kv = parts[i].split('=');
                if(decodeURIComponent(kv[0] || '') === k){
                    return decodeURIComponent(kv[1] || '');
                }
            }
        }catch(_e){}
    }
    return '';
}

function gpNumOrZero(v){
    var n = Math.floor(Number(v) || 0);
    if(!isFinite(n) || n < 0) { n = 0; }
    return n;
}

function gpThemeApply(){
    var drid = gpNumOrZero(gpParamGet('DrID'));
    GP.drid = drid;

    if(typeof BilmedThema === 'function'){
        try{
            BilmedThema(drid, document, false);
            return;
        }catch(e){
            console.error('BILMED_THEME_APPLY_FAIL', e);
            return;
        }
    }
    if(typeof __hb_themeApply === 'function'){
        try{
            __hb_themeApply(drid);
            return;
        }catch(e2){
            console.error('HB_THEME_APPLY_FAIL', e2);
            return;
        }
    }
    console.error('THEME_APPLY_MISSING');
}

function gpInit(){
    try{ gpThemeApply(); }catch(e){ console.error(e); }

    GP.dom = GP.dom || {};
    gpDomCache();

    try{
        if(GP.dom.sizeW){
            GP.dom.sizeW.addEventListener('input', gpOnSizeInputChange);
            GP.dom.sizeW.addEventListener('change', gpOnSizeInputChange);
        }
        if(GP.dom.sizeH){
            GP.dom.sizeH.addEventListener('input', gpOnSizeInputChange);
            GP.dom.sizeH.addEventListener('change', gpOnSizeInputChange);
        }
        try{
            var bs = document.querySelectorAll('.gpSizeBtn');
            for(var i = 0; i < bs.length; i += 1){
                bs[i].addEventListener('click', gpOnSizeBtnClick);
            }
        }catch(e){ console.error(e); }
        gpSizeUiSync();
    }catch(e){ console.error(e); }

    document.addEventListener('dragover', gpOnDocDragOver);
    document.addEventListener('dragend', gpOnDocDragEnd);
    document.addEventListener('drop', gpOnDocDragEnd);
    GP.dom.poolWrap.addEventListener('dragover', gpOnPoolDragOver);
    GP.dom.poolWrap.addEventListener('drop', gpOnPoolDrop);

    try{
        GP.touch.enabled = gpTouchIsActive();
        if(GP.touch.enabled){
            document.addEventListener('pointerdown', gpTouchOnPointerDown, { passive: false });
            document.addEventListener('pointermove', gpTouchOnPointerMove, { passive: false });
            document.addEventListener('pointerup', gpTouchOnPointerUp, { passive: false });
            document.addEventListener('pointercancel', gpTouchOnPointerUp, { passive: false });
            document.addEventListener('click', function(ev){
                try{
                    if(!GP.touch.enabled) { return; }
                    if(Date.now() < Number(GP.touch.blockClickUntil || 0)){
                        ev.preventDefault();
                        ev.stopPropagation();
                        if(ev.stopImmediatePropagation){ ev.stopImmediatePropagation(); }
                    }
                }catch(e){}
            }, true);
            if(GP.dom && GP.dom.gridScroll){
                GP.dom.gridScroll.addEventListener('pointerup', gpTouchOnGridTap, { passive: true });
            }
        }
    }catch(e){ console.error(e); }
try{
        gpCfgLoad();
    }catch(e){}

    try{
        gpGridLoadFromCfg();
    }catch(e){}


    try{
        gpPoolOrderInit();
    }catch(e){ console.error(e); }

    gpGridLayoutApply();
    gpGridRender();
    gpPoolRender();
    gpCfgBaselineSet();
    gpSizeUiSync();
GP.dom.btnSave.addEventListener('click', function(){
        gpSave();
    });

    
    GP.dom.searchInput = document.getElementById('gpSearchInput');
    GP.dom.searchClear = document.getElementById('gpSearchClear');

    GP.dom.searchInput.addEventListener('input', function(){
        var q = this.value.toLowerCase();
        var cards = GP.dom.poolList.children;
        for(var i=0;i<cards.length;i++){
            var t = cards[i].innerText.toLowerCase();
            cards[i].style.display = t.indexOf(q)>=0 ? '' : 'none';
        }
    });

    GP.dom.searchClear.addEventListener('click', function(){
        GP.dom.searchInput.value = '';
        GP.dom.searchInput.dispatchEvent(new Event('input'));
    });

    GP.dom.btnExit.addEventListener('click', function(){
        gpExit();
    });
window.addEventListener('beforeunload', function(e){
        if(gpCfgIsDirty()){
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    window.addEventListener('resize', function(){
        gpGridLayoutApply();
        gpGridRender();
        gpPoolRender();
    });
    GP.dom.gridScroll.addEventListener('dragover', gpOnGridDragOver);
    GP.dom.gridScroll.addEventListener('drop', gpOnGridDrop);
    GP.dom.gridScroll.addEventListener('dragleave', gpOnGridDragLeave);

}


gpInit();
</script>
<img id="gpDragImg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2P8/5+hHgAHggJ/Pq0l3wAAAABJRU5ErkJggg==" style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;" alt="">
<div id="gpDragGhost" class="gpDragGhost" style="display:none"></div>
</body>
</html>